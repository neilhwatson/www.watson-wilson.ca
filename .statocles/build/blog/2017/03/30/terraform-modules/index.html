<!DOCTYPE html>
<html lang="en"> 
    <head>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <link href="/theme/css/readability-bootstrap.min.css" rel="stylesheet">
        <!--<link rel="stylesheet" href="/theme/css/statocles-bootstrap.css" />-->
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Terraform modules - Neil H. Watson</title>
        <meta content="Statocles 0.094" name="generator">
        

        <!-- Twitter for websites -->
         <script>window.twttr = (function(d, s, id) {
           var js, fjs = d.getElementsByTagName(s)[0],
             t = window.twttr || {};
           if (d.getElementById(id)) return t;
           js = d.createElement(s);
           js.id = id;
           js.src = "https://platform.twitter.com/widgets.js";
           fjs.parentNode.insertBefore(js, fjs);

           t._e = [];
           t.ready = function(f) {
             t._e.push(f);
           };

           return t;
         }(document, "script", "twitter-wjs"));</script>

        <!-- For source highlighting -->
        <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/default.min.css" rel="stylesheet">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
        <header>
            <nav class="navbar navbar-default navbar-static-top" role="navigation">
                <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button class="navbar-toggle" data-target="#top-navbar-collapse-1" data-toggle="collapse" type="button">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Neil H. Watson</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="/page/about">About me</a></li>
                            <li><a href="/static/resume_neil_h_watson.pdf">Resume</a></li>
                            <li><a href="/page/projects">Projects</a></li>
                            <li><a href="/page/evolvethinking">UPDATE: EvolveThinking</a></li>
                        </ul>
                        
                    </div>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            <div class="row">

    <div class="col-md-9">
        <main>
            <header>
                <h1>Terraform modules</h1>
                <p class="tags">Tags:
                    <a href="/blog/tag/terraform/" rel="tag">terraform</a>
                    <a href="/blog/tag/cloud/" rel="tag">cloud</a>
                    <a href="/blog/tag/configuration-management/" rel="tag">configuration management</a>
                    <a href="/blog/tag/aws/" rel="tag">AWS</a>
                </p>

                <aside>
                    <p><time datetime="2017-03-30">
                        Posted on 2017-03-30
                    </time>
                    </p>
                </aside>


            </header>
            <section id="section-1">
                <p><a href="https://terraform.io/"><img alt="terraform logo" src="https://raw.githubusercontent.com/hashicorp/terraform-website/master/content//source/assets/images/og-image.png" style="float:right" width="120px"></a></p>

<p>Here&#39;s what I&#39;ve learned so far using Terraform and its modules. I&#39;ve just scratched the surface so test and research on your own.</p>

            </section>
            <section id="section-2">
                <p>Modules allow you to build parameterized reusable code as you would in programming. Terraform scopes its variables strictly, denying access to variables outside of the running module or inside of another. More later.</p>

<p>In our main terraform file we call a module. Terraform is odd in that if you do a terraform plan it will error out until you &#39;get&#39; the module. So always do a &#39;terraform get&#39; first.</p>

<pre><code># Create an s3 bucket with the given name
module &quot;my-s3-bucket&quot; {
    source = &quot;./s3/make_bucket&quot;
    name   = &quot;my-s3-bucket&quot;
}
</code></pre>

<p>The module is all .tf files under ./s3/make_bucket/. In this example we have just one file: main.tf by convention.</p>

<pre><code># Must declare expected inputs:
variable &quot;name&quot; {}

# Build a named bucket
resource &quot;aws_s3_bucket&quot; &quot;web_bucket&quot; {

   bucket = &quot;${var.name}&quot;
   force_destroy = true
   acl = &quot;public-read&quot;
    tags = {
        layer = &quot;terraform&quot;
    }
   policy = &lt;&lt;POLICY
{
  &quot;Version&quot;:&quot;2012-10-17&quot;,
  &quot;Statement&quot;:[{
    &quot;Sid&quot;:&quot;PublicReadForGetBucketObjects&quot;,
        &quot;Effect&quot;:&quot;Allow&quot;,
      &quot;Principal&quot;: &quot;*&quot;,
      &quot;Action&quot;:&quot;s3:GetObject&quot;,
      &quot;Resource&quot;:[&quot;arn:aws:s3:::${var.name}/*&quot;
      ]
    }
  ]
}
POLICY

   website {
      index_document = &quot;index.html&quot;
# TODO 404.html
   }
}

# Allow the bucket id to be dereferenced form outside
output &quot;bucket_id&quot;
   value = &quot;${aws_s3_bucket.web_bucket.id}&quot;
}
</code></pre>

<p>Now if we want to use this bucket in a later policy the output of the module allows us to call</p>

<pre><code>${module.my-s3-bucket.bucket_id}
</code></pre>

<p>You should read more over at <a href="https://www.terraform.io/docs/index.html">terraform.io</a>.</p>

<h4>Don&#39;t use named parameters</h4>

<pre><code>module &quot;mymod&quot; {
    source = &quot;./mymod&quot;
    param  =  {
        one = &quot;my param&quot;
        two = &quot;my other param&quot;
    }
}


# Module starts here
variable &quot;param&quot; {
    type = &quot;map&quot;
    one  = &quot;1&quot;
    two  = &quot;2&quot;
}
</code></pre>

<p>This is a tempting idiom and common in many languages, but it does not work in Terraform. Or rather it does not work as expected. Each parameter passed to a module erases the default declaration in the module. Thus a passed map deletes, and does not merge with, the default declared map. All defaults will be lost.</p>

<h3>Other things I&#39;ve learned about terraform</h3>

<ul>
<li><p>There are no loops. You can&#39;t pass a module a list of data for it to loop over. You must call the module multiple times by hand.</p></li>
<li><p>Use <a href="https://www.terraform.io/docs/state/remote.html">remote state</a>.</p></li>
<li><p>Use a <a href="https://www.terraform.io/docs/providers/aws/index.html">role based host</a> like at an AWS EC2 host with IAM to authorize terraform to access your provider. Avoid storing passwords.</p></li>
<li><p>Terraform plan, plan, and plan more while you get the hang of it.</p></li>
<li><p>If using <a href="https://aws.amazon.com/route53/details/">Route53</a> for your DNS but your domain is registered else where you&#39;ll get new NS AWS servers when create a new zone. So if you destroy and recreate a zone you&#39;ll have to update your registrar.</p></li>
</ul>

<h3>Further reading</h3>

<ul>
<li>My <a href="http://github.com/neilhwatson/nustuff/terraform">Terraform examples</a>.</li>
</ul>

            </section>
        </main>


    </div>

    <div class="col-md-3">
        <iframe frameborder="0" src="https://duckduckgo.com/search.html?site=watson-wilson.ca&amp;prefill=Search DuckDuckGo" style="overflow:hidden;margin:0;padding:0;width:350px;height:40px;"></iframe>

        <nav id="tags">
            <h1>Tags</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/ansible/">ansible</a></li>
                <li><a href="/blog/tag/anti-virus/">anti-virus</a></li>
                <li><a href="/blog/tag/apt/">apt</a></li>
                <li><a href="/blog/tag/asg/">asg</a></li>
                <li><a href="/blog/tag/autoscaling/">autoscaling</a></li>
                <li><a href="/blog/tag/aws/">AWS</a></li>
                <li><a href="/blog/tag/azure/">azure</a></li>
                <li><a href="/blog/tag/backup/">backup</a></li>
                <li><a href="/blog/tag/best-practices/">best practices</a></li>
                <li><a href="/blog/tag/bitbucket/">bitbucket</a></li>
                <li><a href="/blog/tag/bosh/">bosh</a></li>
                <li><a href="/blog/tag/cfengine/">cfengine</a></li>
                <li><a href="/blog/tag/cfengine-cookbook/">cfengine cookbook</a></li>
                <li><a href="/blog/tag/cheatsheet/">cheatsheet</a></li>
                <li><a href="/blog/tag/cli/">cli</a></li>
                <li><a href="/blog/tag/cloud/">cloud</a></li>
                <li><a href="/blog/tag/cloud-foundry/">cloud foundry</a></li>
                <li><a href="/blog/tag/cluster/">cluster</a></li>
                <li><a href="/blog/tag/conferences/">conferences</a></li>
                <li><a href="/blog/tag/configuration-management/">configuration management</a></li>
                <li><a href="/blog/tag/containers/">containers</a></li>
                <li><a href="/blog/tag/continuous-integration/">continuous integration</a></li>
                <li><a href="/blog/tag/cron/">cron</a></li>
                <li><a href="/blog/tag/debian/">debian</a></li>
                <li><a href="/blog/tag/delta-reporting/">delta reporting</a></li>
                <li><a href="/blog/tag/devops/">devops</a></li>
                <li><a href="/blog/tag/dns/">dns</a></li>
                <li><a href="/blog/tag/docker/">docker</a></li>
                <li><a href="/blog/tag/dr/">dr</a></li>
                <li><a href="/blog/tag/efl/">EFL</a></li>
                <li><a href="/blog/tag/ergonomics/">ergonomics</a></li>
                <li><a href="/blog/tag/github/">github</a></li>
                <li><a href="/blog/tag/heartbeat/">heartbeat</a></li>
                <li><a href="/blog/tag/high-availability/">high availability</a></li>
                <li><a href="/blog/tag/infosec/">infosec</a></li>
                <li><a href="/blog/tag/ipv6/">ipv6</a></li>
                <li><a href="/blog/tag/irc/">irc</a></li>
                <li><a href="/blog/tag/iscsi/">iscsi</a></li>
                <li><a href="/blog/tag/jekyll/">jekyll</a></li>
                <li><a href="/blog/tag/jq/">jq</a></li>
                <li><a href="/blog/tag/json/">json</a></li>
                <li><a href="/blog/tag/keyboard/">keyboard</a></li>
                <li><a href="/blog/tag/kickstart/">kickstart</a></li>
                <li><a href="/blog/tag/kvm/">kvm</a></li>
                <li><a href="/blog/tag/lambda/">lambda</a></li>
                <li><a href="/blog/tag/linux/">linux</a></li>
                <li><a href="/blog/tag/markdown/">markdown</a></li>
                <li><a href="/blog/tag/monitoring/">monitoring</a></li>
                <li><a href="/blog/tag/multipathd/">multipathd</a></li>
                <li><a href="/blog/tag/mustache/">mustache</a></li>
                <li><a href="/blog/tag/networking/">networking</a></li>
                <li><a href="/blog/tag/opennms/">opennms</a></li>
                <li><a href="/blog/tag/opensource/">opensource</a></li>
                <li><a href="/blog/tag/oracle/">oracle</a></li>
                <li><a href="/blog/tag/orchestration/">orchestration</a></li>
                <li><a href="/blog/tag/patching/">patching</a></li>
                <li><a href="/blog/tag/pcre/">pcre</a></li>
                <li><a href="/blog/tag/perl/">perl</a></li>
                <li><a href="/blog/tag/posix/">posix</a></li>
                <li><a href="/blog/tag/programming/">programming</a></li>
                <li><a href="/blog/tag/provisioning/">provisioning</a></li>
                <li><a href="/blog/tag/python/">python</a></li>
                <li><a href="/blog/tag/red-hat/">red hat</a></li>
                <li><a href="/blog/tag/redhat/">redhat</a></li>
                <li><a href="/blog/tag/regex/">regex</a></li>
                <li><a href="/blog/tag/rhev/">rhev</a></li>
                <li><a href="/blog/tag/ruby/">ruby</a></li>
                <li><a href="/blog/tag/san/">san</a></li>
                <li><a href="/blog/tag/satellite/">satellite</a></li>
                <li><a href="/blog/tag/scripting/">scripting</a></li>
                <li><a href="/blog/tag/security/">security</a></li>
                <li><a href="/blog/tag/serverless/">serverless</a></li>
                <li><a href="/blog/tag/serverspec/">serverspec</a></li>
                <li><a href="/blog/tag/shell/">shell</a></li>
                <li><a href="/blog/tag/slaac/">slaac</a></li>
                <li><a href="/blog/tag/software-testing/">software testing</a></li>
                <li><a href="/blog/tag/solaris/">solaris</a></li>
                <li><a href="/blog/tag/spacewalk/">spacewalk</a></li>
                <li><a href="/blog/tag/ssh/">ssh</a></li>
                <li><a href="/blog/tag/statocles/">statocles</a></li>
                <li><a href="/blog/tag/subnet/">subnet</a></li>
                <li><a href="/blog/tag/subversion/">subversion</a></li>
                <li><a href="/blog/tag/sun/">sun</a></li>
                <li><a href="/blog/tag/support/">support</a></li>
                <li><a href="/blog/tag/svn/">svn</a></li>
                <li><a href="/blog/tag/sysadmin/">sysadmin</a></li>
                <li><a href="/blog/tag/sysctl/">sysctl</a></li>
                <li><a href="/blog/tag/terraform/">terraform</a></li>
                <li><a href="/blog/tag/virus/">virus</a></li>
                <li><a href="/blog/tag/vitualization/">vitualization</a></li>
                <li><a href="/blog/tag/website/">website</a></li>
                <li><a href="/blog/tag/yaml/">yaml</a></li>
                <li><a href="/blog/tag/yamllint/">yamllint</a></li>
            </ul>
        </nav>
    </div>

</div>

<div class="row">
   <div class="col-md-1">
       <img atl="Neil Watson" src="https://gravatar.com/avatar/1f0969599955a953e592034929ed7a23">
   </div>

       <div class="col-md-1">
            <!-- reddit this -->
            <a href="//www.reddit.com/submit" onclick="window.location = &#39;//www.reddit.com/submit?url=&#39; + encodeURIComponent(window.location); return false"><img alt="submit to reddit" border="0" src="//www.redditstatic.com/spreddit7.gif"></a>
       </div>

       <div class="col-md-1">
          <!-- Tweet this -->
          <a class="twitter-share-button" href="https://twitter.com/intent/tweet">
          Tweet</a>
       </div>

       <div class="col-md-1">
          <!-- follow me on twitter -->
         <a class="twitter-follow-button" data-show-count="false" data-show-screen-name="false" href="https://twitter.com/neil_h_watson">
         Follow @neil_h_watson</a>
        </div>

       <div class="col-md-1">
           <!-- follw me on github -->
            <a aria-label="Follow @neilhwatson on GitHub" class="github-button" data-style="mega" href="https://github.com/neilhwatson">Follow</a>
            <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
       </div>

</div>

        </div>
        <footer>
            
            <h1></h1>
            <div class="col-md-5"> </div>
            <div class="col-md-3 container tagline">
                <a href="http://preaction.me/statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
