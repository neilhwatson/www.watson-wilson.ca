<!DOCTYPE html>
<html>
    <head>
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <link href="/theme/css/readability-bootstrap.min.css" rel="stylesheet">
        <!--<link rel="stylesheet" href="/theme/css/statocles-bootstrap.css" />-->
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Neil H. Watson</title>
        <meta content="Statocles 0.073" name="generator">
        <link href="/blog/index.atom" rel="alternate" type="application/atom+xml">
        <link href="/blog/index.rss" rel="alternate" type="application/rss+xml">
        

        <!-- For source highlighting -->
        <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/default.min.css" rel="stylesheet">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
        <header>
            <nav class="navbar navbar-default navbar-static-top" role="navigation">
                <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button class="navbar-toggle" data-target="#top-navbar-collapse-1" data-toggle="collapse" type="button">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Neil H. Watson</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="/page/about">About me</a></li>
                            <li><a href="/static/resume_neil_h_watson.pdf">Resume</a></li>
                            <li><a href="/page/projects">Projects</a></li>
                        </ul>
                        
                    </div>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            
<div class="row">

    <div class="col-md-9">
        <main>


            <article>
                <header>
                    <h1><a href="/blog/2013/11/27/json-containers-improve-cfengine-and-efl/">JSON containers improve CFEngine and EFL</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/Cfengine/" rel="tag">Cfengine</a>
                        <a href="/blog/tag/EFL/" rel="tag">EFL</a>
                    </p>

                    <aside>
                        <p><time datetime="2013-11-27">
                            Posted on 2013-11-27
                        </time>
                            by nwatson
                        </p>
                    </aside>

                </header>

                <p>CFEngine 3.6 will be able to parse JSON files making EFL data files
more readable. --- The current data format of the <a href="https://github.com/evolvethinking/evolve_cfengine_freelib">Evolve Free Promise
Library</a> is
CSV. CSV files are workable but, become error prone when record lines
become long. In the following example, run using a build from the
CFEngine 3.6 <a href="https://github.com/cfengine/core">source code</a>, the init
bundle creates a data file that we normally maintain by other means. It
exists here for convenience.</p>

<p>The bundle sysctl loads the JSON, indexes it, then iterates through it.
This is similar to how EFL uses the function CFEngine
readstringarrayidx. Imagine a record with many fields, that line wrap
around your screen in CSV form. In JSON format the same data is more
readable.</p>

<p>``</p>

<pre><code>body common control
{
        bundlesequence =&gt; { &quot;main&quot;, };
}

bundle agent main
{
        methods:
                &quot;any&quot; usebundle =&gt; init;
                &quot;any&quot; usebundle =&gt; sysctl( &quot;/tmp/sysctl.json&quot; );
}

bundle agent init 
{
        vars:
                &quot;sysctl&quot; string =&gt; &#39;
[
    {
        &quot;context&quot;: &quot;any&quot;,
        &quot;name&quot;: &quot;net.ipv6.conf.all.accept_ra&quot;,
        &quot;value&quot;: 0,
        &quot;promisee&quot;: &quot;IPV6 Team&quot;
    },
    {
        &quot;context&quot;: &quot;any&quot;,
        &quot;name&quot;: &quot;net.ipv6.conf.default.autoconf&quot;,
        &quot;value&quot;: 0,
        &quot;promisee&quot;: &quot;IPV6 Team&quot;
    }
]
&#39;;
   files:
      &quot;/tmp/sysctl.json&quot;
         edit_defaults =&gt; empty,
         create        =&gt; &#39;true&#39;,
         edit_line     =&gt; el_init( &quot;${sysctl}&quot; );
}

body edit_defaults empty
{
   empty_file_before_editing =&gt; &quot;true&quot;;
   edit_backup               =&gt; &quot;false&quot;;
}

bundle edit_line el_init( str )
{
   insert_lines:
      &quot;${str}&quot;;
}

bundle agent sysctl( ref )
{
   vars:
      &quot;sysctl&quot;
         comment =&gt; &quot;Read json file into container&quot;,
# New vars type &#39;data&#39;.
         data    =&gt; readjson( &quot;${ref}&quot;, 1024 );

      &quot;i&quot;
         comment =&gt; &quot;Get index of json for iteration&quot;,
         slist   =&gt; getindices( &quot;sysctl&quot; );

   reports:
      &quot;
context  =&gt; ${sysctl[${i}][context]}
name     =&gt; ${sysctl[${i}][name]}
value    =&gt; ${sysctl[${i}][value]}
promisee =&gt; ${sysctl[${i}][promisee]}
&quot;;
}

$ cf-agent -f ./json.cf
2013-11-27T13:48:04-0500   notice: /main/methods/&#39;any&#39;/sysctl: R: 
context  =&gt; any
name     =&gt; net.ipv6.conf.all.accept_ra
value    =&gt; 0
promisee =&gt; IPV6 Team

2013-11-27T13:48:04-0500   notice: /main/methods/&#39;any&#39;/sysctl: R: 
context  =&gt; any
name     =&gt; net.ipv6.conf.default.autoconf
value    =&gt; 0
promisee =&gt; IPV6 Team
</code></pre>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2013/11/21/bulding-cfengine-classes-using-efl/">Bulding CFEngine classes using EFL</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/Cfengine/" rel="tag">Cfengine</a>
                        <a href="/blog/tag/EFL/" rel="tag">EFL</a>
                    </p>

                    <aside>
                        <p><time datetime="2013-11-21">
                            Posted on 2013-11-21
                        </time>
                            by nwatson
                        </p>
                    </aside>

                </header>

                <p>Recently my CFEngine colleague <a href="http://syslog.me/">Marco Marongiu</a>
wrote about <a href="http://syslog.me/2013/11/18/external-node-classification-the-cfengine-way/">classifying CFEngine hosts via external means</a>.
His post inspired me to write about classifying hosts using <a href="http://watson-wilson.ca/tag/efl/">EFL</a>.</p>


                    <p><a href="/blog/2013/11/21/bulding-cfengine-classes-using-efl/index.html#section-2">Continue reading Bulding CFEngine classes using EFL...</a></p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2013/10/31/opennms-the-open-source-enterprise-monitoring-solution-youve-never-heard-of/">OpenNMS: the open source enterprise monitoring solution you&#39;ve never heard of.</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/monitoring/" rel="tag">monitoring</a>
                        <a href="/blog/tag/opennms/" rel="tag">opennms</a>
                    </p>

                    <aside>
                        <p><time datetime="2013-10-31">
                            Posted on 2013-10-31
                        </time>
                            by nwatson
                        </p>
                    </aside>

                </header>

                <p><a href="http://www.opennms.org"><img alt="opennms logo" src="/static/images/opennms.png"></a></p>

<p>Begun in 1999, <a href="http://www.opennms.org">OpenNMS</a> an enterprise scale
monitoring solution written in Java, with a Postgresql database and
configured with XML files. --- Because it uses SNMP OpenNMS can monitor
most servers, network gear, and other appliances without needing a
custom agent. Its <a href="http://www.opennms.org/wiki/Features_List">feature list</a>
is impressive.</p>

<h3>When monitoring, less is more.</h3>

<p>I&#39;ve seen a lot of monitoring products in production over the years,
both proprietary and open source. Most suffer from information overload
because folks set out trying to monitoring everything. They believe
they can catch all problems early, but this never works. Staff are
inundated with so many alerts, most of them false, that searching for
legitimate ones becomes a full time job, or worse, alerts are
intentionally ignored. If you are monitoring or plan to start, start
small, very small, and grow slowly.</p>

<h3>What I like about OpenNMS</h3>

<ul>
<li><p>No message storms. OpenNMS has message correlation, multiple
messages meaning the same thing result in only one alert. A feature
called critical path ensures that multiple and different messages
result in only one alert. For example, if a router is identified as
a critical path, OpenNMS will not generate a storm of alerts for
all hosts behind the router if it goes down.</p></li>
<li><p>Commercial support. OpenNMS creators offer paid support and
consulting services. For do-it-yourselfers, there is a <a href="http://www.opennms.org/wiki/Mailing_lists">mailing
lists</a>, a <a href="http://www.opennms.org/wiki/Tutorial">wiki</a>,
and the #opennms IRC channel at <a href="http://freenode.net">Freenode</a>.</p></li>
<li><p>Scale and stability. OpenNMS was designed from day one to scale to
thousands of nodes at low cost.</p></li>
<li><p>Simple to install. I was able to install and run OpenNMS on a small
virtual host without difficulty.</p></li>
<li><p>SNMP. OpenNMS is not limited to servers supported by a custom
agent. By using SNMP, OpenNMS can support servers, network gear,
storage gear, UPS gear, and so much more. For those of you who
think that SNMP is long in the tooth, look at SNMP version 3, with
more functionality and <a href="https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol#Version_3">full encryption</a>.</p></li>
</ul>

<h1>#</h1>

<h3>What I don&#39;t like about OpenNMS</h3>

<ul>
<li><p>I&#39;m not a fan Java. I&#39;ve been disappointed by many Java
applications over the years, but I had no such disappointment with
OpenNMS. The installation process is easy. One problem I did
encounter, with no solution yet, is that OpenNMS does not start a
boot, no matter what I tried. I resorted to having CFEngine promise
to keep it running.</p></li>
<li><p>Editing XML files sucks. XML was not made for people to ready
continuously.</p></li>
<li><p>Merging XML files for upgrades sucks more. When I upgraded OpenNMS
I was faced with the frustrating exercise of merging the upgrades
with my preexisting changes.</p></li>
<li><p>Confusing documentation. The wiki is often outdated or incomplete.
There is a <a href="https://github.com/OpenNMS/opennmsbook">book</a>, but it
was not easy to find.</p></li>
</ul>

<h1>#</h1>

<p>Every monitoring product I&#39;ve worked with has things I don&#39;t like, so
don&#39;t think I&#39;m singling OpenNMS out. We are now using OpenNMS to
monitor our gear at Evolve and OpenNMS is at the top of my list for any
future monitoring projects.</p>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2013/10/30/cfengine-2-to-3-migration-beware-of-data-loss/">CFEngine 2 to 3 migration? Beware of data loss</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/Cfengine/" rel="tag">Cfengine</a>
                    </p>

                    <aside>
                        <p><time datetime="2013-10-30">
                            Posted on 2013-10-30
                        </time>
                            by nwatson
                        </p>
                    </aside>

                </header>

                <p>CFEengine 3 bootstrapping can result in the loss of CFEngine 2 inputs.
A common strategy to migrate from CFEngine 2 to 3 is to run both in
parallel. --- Both versions share the same default inputs directory of
/var/cfengine/inputs. A CF3 bootstrap deletes all files in the inputs
directory:</p>

<p>``</p>

<pre><code>[root@atlrhel5is cfengine]# cf-agent -IB hub.example.com 
2013-10-29T12:37:43-0400     info: Removing all files in &#39;/var/cfengine/inputs/&#39;
</code></pre>

<p><em>Now your working CF2 inputs are gone.</em> I&#39;ve reported a <a href="https://cfengine.com/dev/issues/3605">bug</a>
about this, but I do not know when or if it will be addressed. As a
work around I suggest a wrapper script to your bootstrap procedure.
Something like this snippet:</p>

<p>``</p>

<pre><code>TS=$(date +%s)

mkdir /var/cfengine/inputs-${TS}
cp -r /var/cfengine/inputs/* /var/cfengine/inputs-${TS}

if [ $? -eq 0 ]
   then
      cf-agent -B hub.example.com
      cp -nr /var/cfengine/inputs-${TS}/* /var/cfengine/inputs/
fi
</code></pre>

<p>This will preserve and restore your pre-bootstrap inputs, while keeping
any new files created by the bootstrap. Be sure to test any bootstrap
or upgrade procedure thoroughly. <a href="http://watson-wilson.ca/contact-us/">Contact us</a>
for more help and information.</p>



            </article>
            <article>
                <header>
                    <h1><a href="/blog/2013/10/19/simple-cfengine-server-access-promises-using-efl/">Simple CFEngine server access promises using EFL</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/Cfengine/" rel="tag">Cfengine</a>
                        <a href="/blog/tag/EFL/" rel="tag">EFL</a>
                    </p>

                    <aside>
                        <p><time datetime="2013-10-19">
                            Posted on 2013-10-19
                        </time>
                            by nwatson
                        </p>
                    </aside>

                </header>

                <p>Here&#39;s an EFL bundle that simplifies access promises for cf-serverd.
CFEngine users with a complex environment will especially benefit. ---
The <a href="http://watson-wilson.ca/make-cfengine-simple-using-the-evolve-free-library/">Evolve Thinking Free Library or EFL</a>
provides commonly used promise bundles that you can configure using
simple CSV parameter files. You don&#39;t need a PHD in CFEngie to get
things done.</p>

<p>Unlike EFL agent bundles the server bundle efl_server cannot be passed
parameter files. The is a CFEngine limit. Instead variable
&#39;efl_server_txt&#39; in the bundle &#39;efl_c&#39; defines the location of the
parameter file to
${sys.workdir}/inputs/user_data/bundle_params/efl_server.txt. The file
format has four columns from zero to three.</p>

<ul>
<li><p>Zero is the constraining class expression. The record is only
promised if this class expression is true.</p></li>
<li><p>One is the promiser directory that we are granting access to.</p></li>
<li><p>Two is comma separated list of IP&#39;s or hostnames who we grant
access to (see <a href="https://cfengine.com/docs/3.5/reference-promise-types-access.html#admit">admit</a>).</p></li>
<li><p>Three is a free form promisee for documentation and searching.</p></li>
</ul>

<p>`</p>

<pre><code># Context(0) ;; promiser directory(1) ;; Command separated admit list(2) ;; Promisee(3)

am_policy_hub ;; ${sys.workdir}/masterfiles ;;  2001:470:1d:a2f::/64 ;; Bootstrapping and updates
ettin    ;; ${sys.workdir}/private/alix/ ;; 2001:470:1d:a2f::1 ;; 6in4 tunnel
mercury  ;; /var/www/blog1/              ;; ${sys.policy_hub}  ;; Backups
titan    ;; /var/www/evolve/             ;; ${sys.policy_hub}  ;; Backups
any      ;; ${sys.workdir}/drop/         ;; ${sys.policy_hub}  ;; File transfers as needed
</code></pre>

<p>`</p>

<p>If you run cf-serverd -Fvl you&#39;ll see the access rules being applied.</p>

<p>``</p>

<pre><code>cf3&gt; *****************************************************************
cf3&gt; BUNDLE efl_server
cf3&gt; *****************************************************************
cf3&gt;    =========================================================
cf3&gt;    access in bundle efl_server (0)
cf3&gt;    =========================================================
cf3&gt; . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
cf3&gt; Skipping whole next promise (/var/www/evolve-wp/), as var-context titan is not relevant
cf3&gt; . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
cf3&gt; . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
cf3&gt; Skipping whole next promise (/var/www/blog1/), as var-context mercury is not relevant
cf3&gt; . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
cf3&gt; Summarize control promises
cf3&gt; Granted access to paths :
cf3&gt; Path &#39;/var/cfengine/private/alix&#39; (encrypt=0)
cf3&gt; Admit: &#39;2001:470:1d:a2f::1&#39; root=
cf3&gt; Path &#39;/var/cfengine/drop&#39; (encrypt=0)
cf3&gt; Admit: &#39;2001:470:1d:a2f::2&#39; root=
</code></pre>

<p>When you upgrade CFEngine the upgrade offers new inputs like the sever
bundle &#39;access_rules&#39; in the file cf_server.cf. If you have access
rules in that bundle you&#39;ll need to merge the old file with the
upgrade&#39;s improved file. Using the efl_server bundle the data is
separated from policy eliminating the need to merge policy files.</p>



            </article>
        </main>

        <ul class="pager">
            <li class="previous ">
                <a href="/blog/page/10" rel="next"><span aria-hidden="true" class="glyphicon glyphicon-chevron-left"></span>Older</a>
            </li>
            <li class="next ">
                <a href="/blog/page/8" rel="prev">Newer<span aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span></a>
            </li>
        </ul>

    </div>

    <div class="sidebar col-md-3">
        <iframe frameborder="0" src="https://duckduckgo.com/search.html?site=watson-wilson.ca&amp;prefill=Search DuckDuckGo" style="overflow:hidden;margin:0;padding:0;width:350px;height:40px;"></iframe>

        <h1>Tags</h1>
        <ul class="list-inline">
            <li><a href="/blog/tag/Cfengine/">Cfengine</a></li>
            <li><a href="/blog/tag/EFL/">EFL</a></li>
            <li><a href="/blog/tag/anti-virus/">anti-virus</a></li>
            <li><a href="/blog/tag/apt/">apt</a></li>
            <li><a href="/blog/tag/backup/">backup</a></li>
            <li><a href="/blog/tag/best-practices/">best practices</a></li>
            <li><a href="/blog/tag/cfengine/">cfengine</a></li>
            <li><a href="/blog/tag/cfengine-cookbook/">cfengine cookbook</a></li>
            <li><a href="/blog/tag/cheatsheet/">cheatsheet</a></li>
            <li><a href="/blog/tag/cli/">cli</a></li>
            <li><a href="/blog/tag/cloud/">cloud</a></li>
            <li><a href="/blog/tag/cluster/">cluster</a></li>
            <li><a href="/blog/tag/conferences/">conferences</a></li>
            <li><a href="/blog/tag/configuration-management/">configuration management</a></li>
            <li><a href="/blog/tag/cron/">cron</a></li>
            <li><a href="/blog/tag/debian/">debian</a></li>
            <li><a href="/blog/tag/delta-reporting/">delta reporting</a></li>
            <li><a href="/blog/tag/devops/">devops</a></li>
            <li><a href="/blog/tag/dns/">dns</a></li>
            <li><a href="/blog/tag/dr/">dr</a></li>
            <li><a href="/blog/tag/heartbeat/">heartbeat</a></li>
            <li><a href="/blog/tag/high-availability/">high availability</a></li>
            <li><a href="/blog/tag/infosec/">infosec</a></li>
            <li><a href="/blog/tag/ipv6/">ipv6</a></li>
            <li><a href="/blog/tag/irc/">irc</a></li>
            <li><a href="/blog/tag/iscsi/">iscsi</a></li>
            <li><a href="/blog/tag/jekyll/">jekyll</a></li>
            <li><a href="/blog/tag/kickstart/">kickstart</a></li>
            <li><a href="/blog/tag/kvm/">kvm</a></li>
            <li><a href="/blog/tag/linux/">linux</a></li>
            <li><a href="/blog/tag/monitoring/">monitoring</a></li>
            <li><a href="/blog/tag/multipathd/">multipathd</a></li>
            <li><a href="/blog/tag/mustache/">mustache</a></li>
            <li><a href="/blog/tag/networking/">networking</a></li>
            <li><a href="/blog/tag/opennms/">opennms</a></li>
            <li><a href="/blog/tag/opensource/">opensource</a></li>
            <li><a href="/blog/tag/oracle/">oracle</a></li>
            <li><a href="/blog/tag/patching/">patching</a></li>
            <li><a href="/blog/tag/pcre/">pcre</a></li>
            <li><a href="/blog/tag/perl/">perl</a></li>
            <li><a href="/blog/tag/posix/">posix</a></li>
            <li><a href="/blog/tag/programming/">programming</a></li>
            <li><a href="/blog/tag/provisioning/">provisioning</a></li>
            <li><a href="/blog/tag/red-hat/">red hat</a></li>
            <li><a href="/blog/tag/redhat/">redhat</a></li>
            <li><a href="/blog/tag/regex/">regex</a></li>
            <li><a href="/blog/tag/rhev/">rhev</a></li>
            <li><a href="/blog/tag/san/">san</a></li>
            <li><a href="/blog/tag/satellite/">satellite</a></li>
            <li><a href="/blog/tag/scripting/">scripting</a></li>
            <li><a href="/blog/tag/security/">security</a></li>
            <li><a href="/blog/tag/serverspec/">serverspec</a></li>
            <li><a href="/blog/tag/shell/">shell</a></li>
            <li><a href="/blog/tag/software-testing/">software testing</a></li>
            <li><a href="/blog/tag/solaris/">solaris</a></li>
            <li><a href="/blog/tag/spacewalk/">spacewalk</a></li>
            <li><a href="/blog/tag/ssh/">ssh</a></li>
            <li><a href="/blog/tag/statocles/">statocles</a></li>
            <li><a href="/blog/tag/subversion/">subversion</a></li>
            <li><a href="/blog/tag/sun/">sun</a></li>
            <li><a href="/blog/tag/support/">support</a></li>
            <li><a href="/blog/tag/svn/">svn</a></li>
            <li><a href="/blog/tag/sysadmin/">sysadmin</a></li>
            <li><a href="/blog/tag/sysctl/">sysctl</a></li>
            <li><a href="/blog/tag/terraform/">terraform</a></li>
            <li><a href="/blog/tag/virus/">virus</a></li>
            <li><a href="/blog/tag/vitualization/">vitualization</a></li>
            <li><a href="/blog/tag/website/">website</a></li>
        </ul>
        <h1>Feeds</h1>
        <ul class="list-inline">
            <li>
                <a href="/blog/index.atom" rel="alternate" type="application/atom+xml">
                    Atom
                </a>
            </li>
            <li>
                <a href="/blog/index.rss" rel="alternate" type="application/rss+xml">
                    RSS
                </a>
            </li>
        </ul>
    </div>

</div>


        </div>
        <footer>
            
            <h1></h1>
            <div class="col-md-5"> </div>
            <div class="col-md-3 container tagline">
                <a href="http://preaction.me/statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
