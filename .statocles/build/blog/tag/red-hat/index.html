<!DOCTYPE html>
<html>
    <head>
        <link href="/theme/css/normalize.css" rel="stylesheet">
        <link href="/theme/css/skeleton.css" rel="stylesheet">
        <link href="/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Neil H. Watson</title>
        <meta content="Statocles 0.055" name="generator">
        <link href="/blog/tag/red-hat.atom" rel="alternate" type="application/atom+xml">
        <link href="/blog/tag/red-hat.rss" rel="alternate" type="application/rss+xml">
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">Neil H. Watson</a>
                    <ul>
                        <li>
                            <a href="/">Blog</a>
                        </li>
                    </ul>
                    
                </div>
            </nav>
            
        </header>
        <div class="main container">
            
<div class="row">

    <div class="nine columns">
        <main>


            <article>
                <header>
                    <h1><a href="/blog/2007/08/08/clustering-with-redhat/">Clustering with Red Hat</a></h1>

                    <p class="tags">Tags:
                        <a href="/blog/tag/cluster/" rel="tag">cluster</a>
                        <a href="/blog/tag/high-availability/" rel="tag">high availability</a>
                        <a href="/blog/tag/red-hat/" rel="tag">red hat</a>
                    </p>

                    <aside>
                        <p><time datetime="2007-08-08">
                            Posted on 2007-08-08
                        </time>
                        </p>
                    </aside>

                </header>

                <p>This entry presents an overview of how to build a DB2 service cluster using the Red Hat Cluster Suite. This procedure can be useful in learning how to setup clusters for other services.</p>

<p>Contents</p>

<pre><code>Cluster Options
    Redhat Cluster Software
        Good
        Bad
    Load Balancer
        Good
        Bad

Installation
    Install Redhat Linux AS 4 on primary node:
    Install DB2 on primary node:
    Prepare additional nodes

Configuring the Cluster Suite
    Configuring the cluster
    Additional service considerations

Testing the Cluster
    Turn off the network
        Expected results
        Actual results
    Unmount the shared partition
        Expected results
        Actual results
    Stop DB2
        Expected results
        Actual results
    Unplug a single network cable
        Expected results
        Actual results
    Shutdown node
        Expected results
        Actual results
    Unplug fiber cable
        Expected results
        Actual results
    Turn off the network during a DB2 write
        Expected results
        Actual results
    Unplug fiber cable during a DB2 write
        Expected results
        Actual results

Managing the cluster
    Manual fail over
        Fail over node
        Remove node from cluster
        Perform off line maintenance
        Return node to cluster
    Checking cluster status
        X Windows GUI
        Command line interface
    Log files
        Status check
        Failover

Conclusions
References and Additional Reading
DB2 init script
</code></pre>

<p>Cluster Options</p>

<p>After consideration it was decided to use the Redhat Cluster Suite.
Redhat Cluster Software</p>

<p>The Redhat Cluster Suite offers a prepackaged front-end to setup and manage high availability Linux clusters. Using this method, the cluster nodes share a single copy of the data. A “fence” is used to ensure that only a single node at a time is using the data.
Good</p>

<pre><code>Software is already available at no extra cost.
Redhat support is available at no extra cost.
</code></pre>

<p>Bad</p>

<pre><code>If the SAN fails the cluster fails.
All nodes could fail if the shared data is corrupted.
</code></pre>

<p>Load Balancer</p>

<p>Each cluster node has its own copy of the data. The data is replicated either synchronously or asynchronously. Service requests are directed to the load balancer which decides which node to direct the request to.
Good</p>

<pre><code>Data redundancy.
Speed could be improved if all nodes are active.
</code></pre>

<p>Bad</p>

<pre><code>Load balancing hardware will need to be purchased.
If the SAN fails the cluster fails.
</code></pre>

<p>Installation</p>

<p>The chief reference for this procedure is the Redhat Cluster Suite documentation provided by Redhat (see appendix). It should be read fully in order to understand this article and to be sure there are no syntax changes between revisions of this paper and Redhat’s documentation.
Install Redhat Linux AS 4 on primary node:</p>

<pre><code>In the /etc/hosts file make entries for each node in the cluster:

172.16.1.203    hadrian.example.com hadrian
172.16.1.204    caesar.example.com caesar

Bond two of the four Ethernet cards. Be sure that the network switch is set to auto negotiate. Forcing protocols can break bonding.
In /etc/modprobe.conf add these lines:

install bond0 /sbin/modprobe bonding -o bond0 mode=1 miimon=100

Edit /etc/sysconfig/network-scripts/ifcfg-eth0 to:

DEVICE=eth0
USERCTL=no
ONBOOT=yes
MASTER=bond0
SLAVE=yes
BOOTPROTO=none

Edit /etc/sysconfig/network-scripts/ifcfg-eth1 to:

DEVICE=eth1
USERCTL=no
ONBOOT=yes
MASTER=bond0
SLAVE=yes
BOOTPROTO=none

Create the file /etc/sysconfig/network-scripts/ifcfg-bond0 to:

DEVICE=bond0
USERCTL=no
ONBOOT=yes
BROADCAST=176.16.1.255
NETWORK=172.16.1.0
NETMASK=255.255.255.0
GATEWAY=172.16.1.1
IPADDR=172.16.1.203

Activate the bonding by restarting the network service. Test for fail over.
Stop all unneeded services from starting at boot.

chkconfig --del &lt;service&gt;

Install the NTP service and point it to 209.50.68.2.
Install Redhat Cluster Suite by subscribing the system to the channel and running up2date.

 up2date --installall rhel-x86_64-as-cluster

Create the shared partition on a SAN. Format it to ext3. Ensure that the server can mount the shared partition but do not allow the server to mount this partition automatically. Make fstab entry with the noauto option to prevent mount and boot time.
Install HP Insight management software suite.
Install Perl SSL module for iLO management
up2date -i perl-Crypt-SSLeay
</code></pre>

<p>Install DB2 on primary node:</p>

<pre><code>Certain memory related kernel paramters must be set. Add these lines to /etc/sysctl.conf. (see Appendix A).

kernel.sem=250 256000 32 1024
#Example shmmax for a 64-bit system
kernel.shmmax=1073741824
#Example shmall for 90 percent of 16 GB memory
kernel.shmall=3774873
kernel.msgmax=65535
kernel.msgmnb=65535

Unpack required DB2 binaries. These may be different for each install.
Run db2install program.
Choose directory /opt/ibm/db2/V9.1.
Choose type “ESE”.
Create group db2fence.
Create group db2inst.
Create user db2fence with db2fence group membership and with the shell /sbin/nologin.
Create user dwapinst with db2inst membership. Users will access this with sudo only.
Issue the command:
db2icrt -a SERVER -p 30001 -s ese -u db2fence dwapinst.
Disable fault monitor to prevent DB2 from spawning without cluster control: /opt/ibm/db2/V9.1/bin/db2fmcu -d.
Create an init script to stp and start the DB2 service (see Appendix B). Ensure that the service does not start at boot time.
</code></pre>

<p>Prepare additional nodes</p>

<p>Repeat the above steps on all participating cluster nodes. Be sure to change the IP address each time. One could also clone the nodes and then change the IP addresses and host names afterwards. The second node will have address 172.16.1.204.
Configuring the Cluster Suite
Configuring the cluster</p>

<pre><code>SSH to the primary node using the -YC switches for X forwarding.
Run the system-config-cluster application.
The application will prompt the user to create a new configuration.
Choose the dlm lock method.
Name the cluster “dcdb”.
Create iLO fence devices for each node.
Add all nodes to the cluster. Configure the iLO fence for each node.
Add the shared file system to the resources section. Check the “force unmount” and the “reboot host node of unmount fails” boxes.
Add the cluster’s floating IP (172.16.1.205) to the resources section. The floating IP is the IP address that is used to access the service that is being clustered. The Cluster Suite will assign this IP address to the active node.
Add the DB2 init script (see Appendix) to the resources section.
Add the DB2 service to the cluster and include all the shared resources above. Set the recovery policy to “restart”. Check the “autostart this service” box.
Propagate the cluster configuration by copying the file
/etc/cluster/cluster.conf to each node.
</code></pre>

<p>Additional service considerations</p>

<p>A cluster may have additional services that are not clustered but, must be aware of the clustering environment. Cron is a good example. Suppose a cron job has to be run to help maintain the clustered service or to provide some sort of reporting. If the cron job were to run on a standby node then it would fail. If the cron job were running on the active node during a fail over what would happen?</p>

<p>If a cron job has to be run only on the active node then some checks should be performed before the job is run. For example, the job could check for the presence of share resources. Is the shared partition mounted? Is the DB2 service running? Multiple checks are better than just one. It may also be useful to store the scripts on the shared partition. Although cron would call them, they would not be run on non-active nodes since the mount would not be valid. Additionally, the job should be able to check for completion and report any error that may have been caused by fail over.</p>

<p>Finally, remember that service related cron table entries will need to be duplicated across each node. Other information that may need duplication across nodes are user accounts and group IDs.
Testing the Cluster</p>

<p>Prior to deploying the cluster into service it should be tested to ensure fail over happens as and when expected. Prepare test cases for the node. The current expected results for each test are only estimates. Proper testing will clarify how the cluster suite manages these problems.
Turn off the network
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster.
Actual results</p>

<p>The cluster’s standby node activated in about 2 minutes. Within 4 minutes the failed node had been rebooted and instated as the standby node.
Unmount the shared partition
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster.
Actual results</p>

<p>The cluster remounted the shared partition and restarted the DB2 service. The restart was completed in less than one minute.
Stop DB2
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster. The status of the cluster can be tested with: clustat.
Actual results</p>

<p>The cluster stops all the shared resources, including DB2 even though it is already stopped. The cluster then restarted all the shared resources on the same node. The service was returned to normal in under one minute.
Unplug a single network cable
Expected results</p>

<p>Since two Ethernet cards are bonded in fail over mode this should not impact service at all. The kernel should start the standby card within a few seconds.
Actual results</p>

<p>The results were as expected.
Shutdown node</p>

<p>The node is powered off without issuing a software shutdown.
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster. The status of the cluster can be tested with: clustat.
Actual results</p>

<p>The cluster activated the standby node within two minutes. The cluster, using the iLO fence, turned the power on to the failed node. The node then booted as normal and was returned to the cluster as a standby node.
Unplug fiber cable
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster.
Actual results</p>

<p>The cluster failed over as expected. Once the fiber cable was plugged again in the failed node was returned to the cluster as a standby node.
Turn off the network during a DB2 write
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster.
Actual results</p>

<p>The cluster failed over to the standby node in less than two minutes. The failed node was then rebooted and returned to standby service automatically. The data being written to DB2 was completed up to the last commit. Uncommitted data was lost.
Unplug fiber cable during a DB2 write
Expected results</p>

<p>The cluster should fail over to the standby node. The elapsed time for this may impact the SLA for the cluster.
Actual results</p>

<p>The cluster moved the service to the standby node. The previously active node was left as is. The data being written to DB2 was complete up to the last commit. Uncommitted data was lost.
Managing the cluster</p>

<p>During the life of the cluster, the administrator will need to perform certain tasks regularly. The following is a list of those tasks and how to complete them.
Manual fail over</p>

<p>Bringing a node down for maintenance is a normal operation that allows administrators to maintain servers without affecting service. Also, such maintenance can be performed during normal working hours.
Fail over node</p>

<p>If the node to be brought down is the currently running node then the service must be moved to a standby node. On the running node issue this command:
/usr/sbin/clusvcadm -r db2 -m caesar
This instructs the cluster to move the service (db2) to another node (caesar). The cluster will then stop the service and restart it on the other node. Downtime while the service is moved should less than thirty seconds.
Remove node from cluster</p>

<p>The node that is now down must be marked out of service to the cluster. This will prevent the cluster from attempting to use it if the running node should fail. Stop these services, in order, and then ensure that they do not start at boot time:</p>

<p>service rgmanager stop
service fenced stop
service cman stop
service ccsd stop</p>

<p>chkconfig --del rgmanager
chkconfig --del fenced
chkconfig --del cman
chkconfig --del ccsd</p>

<p>Perform off line maintenance</p>

<p>Now the node is now not part of the cluster. It can be upgraded, rebooted or anything else that is required without affecting the cluster.
Return node to cluster</p>

<p>The node must now be added back to the cluster.</p>

<p>chkconfig --add rgmanager
chkconfig --add fenced
chkconfig --add cman
chkconfig --add ccsd</p>

<p>service ccsd start
service cman start
service fenced start
service rgmanager start</p>

<p>Checking cluster status</p>

<p>The current status of the cluster can be checked in two ways.
X Windows GUI</p>

<p>You must have a working X server to use this option.</p>

<pre><code>SSH to any node using the -YC switches for X forwarding.
Run the system-config-cluster application.
</code></pre>

<p>Command line interface</p>

<p>The command clustat will return the status of the cluster. For example:</p>

<p>[root@hadrian ~]# clustat
Member Status: Quorate</p>

<p>Member Name                  Status
  ------ ----                  ------
  hadrian                      Online, Local, rgmanager
  caesar                       Online, rgmanager</p>

<p>Service Name   Owner (Last)             State <br>
  ------- ----   ----- ------             ----- <br>
  db2            hadrian                  started</p>

<p>Log files</p>

<p>The cluster suite logs events in the file /var/log/messages. The cluster logs status events and fail overs. For example:
Status check</p>

<p>Aug 16 15:09:40 caesar clurgmgrd: [5159]: <info> Executing
/etc/rc.d/init.d/db2 status 
Aug 16 15:09:40 caesar su(pam_unix)[28369]: session opened for user dwapinst by
(uid=0)
Aug 16 15:09:40 caesar su: 
Aug 16 15:09:40 caesar su: Instance  : dwapinst
Aug 16 15:09:40 caesar su: DB2 State : Available
Aug 16 15:09:40 caesar su(pam_unix)[28369]: session closed for user dwapinst
Aug 16 15:09:40 caesar db2:  succeeded</info></p>

<p>Failover</p>

<p>Aug 16 15:03:26 hadrian kernel: end_request: I/O error, dev sda, sector 65
Aug 16 15:03:26 hadrian kernel: EXT3-fs: unable to read superblock
Aug 16 15:03:26 hadrian clurgmgrd: [4679]: <err> &#39;mount -t ext3
/dev/sda1 /db2&#39; failed, error=32
Aug 16 15:03:26 hadrian clurgmgrd[4679]: <notice> start on fs &quot;db2&quot;
returned 2 (invalid argument(s))
Aug 16 15:03:26 hadrian clurgmgrd[4679]: <warning> #68: Failed to start
db2; return value: 1
Aug 16 15:03:26 hadrian clurgmgrd[4679]: <notice> Stopping service db2
Aug 16 15:03:26 hadrian clurgmgrd: [4679]: <info> Executing
/etc/rc.d/init.d/db2 stop
Aug 16 15:03:26 hadrian su(pam_unix)[27368]: session opened for user dwapinst
by (uid=0)
Aug 16 15:03:26 hadrian su:
Aug 16 15:03:26 hadrian su: Instance  : dwapinst
Aug 16 15:03:26 hadrian su: DB2 State : Operable
Aug 16 15:03:26 hadrian su(pam_unix)[27368]: session closed for user dwapinst
Aug 16 15:03:26 hadrian db2:  failed
Aug 16 15:03:26 hadrian db2:  succeeded
Aug 16 15:03:26 hadrian clurgmgrd: [4679]: <info> /dev/sda1 is not
mounted
Aug 16 15:03:31 hadrian clurgmgrd[4679]: <notice> Service db2 is
recovering
Aug 16 15:03:31 hadrian clurgmgrd[4679]: <warning> #71: Relocating failed
service db2
Aug 16 15:03:35 hadrian clurgmgrd[4679]: <notice> Service db2 is now
running on member 1</notice></warning></notice></info></info></notice></warning></notice></err></p>

<p>Conclusions</p>

<p>The Redhat Cluster Suite can offer a significant amount of redundancy above that of a single, well built server. Additionally, down time is reduced since cluster nodes can be maintained at leisure with little impact on service delivery. A chain is only as strong as its weakest link. An important proverb when building a cluster. While the nodes are redundant, external hardware may not be. Are all the nodes connected to the same network switch? Are they connected to the same UPS? Do the nodes rely on the same gateway router? The cluster in this paper does not include a redundant infrastructure</p>

<p>It should also be noted that the client must be able to account for a fail over. During the write tests, some data was lost. The client must be able to confirm its writes, know when a failure has occurred and be able to continue after its last success. Similarly, if a client is reading from the cluster it should be able to, where possible, detect a connection loss and repeat the request.</p>

<p>Although this paper discusses a DB2 cluster, it could be easily applied to cluster other services like Apache or Bind. It is even possible to have a cluster provide more than one service. Clusters can also be configured with load balancing instead of or, in addition to redundancy.</p>

<p>References and Additional Reading</p>

<pre><code>Redhat Cluster Suite
http://www.redhat.com/docs/manuals/csgfs/browse/rh-cs-en/index.html
Linux Ethernet Bonding
http://linux-net.osdl.org/index.php/Bonding
High Availability Linux
http://www.linux-ha.org/
Kernel Parameters for Linux
http://publib.boulder.ibm.com/infocenter/db2luw/v9/index.jsp?topic=/com.ibm.db2.udb.uprun.doc/doc/t0008238.htm
</code></pre>

<p>DB2 init script</p>

<h1>!/bin/bash</h1>

<p>#</p>

<h1>----------------------------  /etc/init.d/db2 ------------------------</h1>

<h1>db2</h1>

<p>#</p>

<h1>description:  Start up the db2 service</h1>

<h1>Source function library.</h1>

<p>. /etc/rc.d/init.d/functions</p>

<h1>Application owner</h1>

<p>USER=dwapinst</p>

<p>RETVAL=0
prog=&quot;db2&quot;</p>

<p>start() {
    echo -n $&quot;Starting $prog:&quot;
    initlog -c &quot;/bin/su - $USER -c         &#39;db2start&#39;&quot; &amp;&amp; success || failure
    RETVAL=$?
    echo &quot;&quot;</p>

<p>}</p>

<p>status() {
    initlog -c &quot;/bin/su - $USER -c         &#39;db2gcf -s&#39;&quot; &amp;&amp; success || failure
    RETVAL=$?
    echo &quot;&quot;
}</p>

<p>stop() {
    echo -n $&quot;Stopping $prog:&quot;</p>

<pre><code># Is DB2 already stopped?
status
if [ $RETVAL -gt 0 ]; then

    # Already stoped return 0
    echo &quot;Already stopped&quot;
    success
    RETVAL=0
    echo &quot;&quot;
else
    # DB2 must still be running.  Stop it.
    initlog -c &quot;/bin/su - $USER -c             &#39;db2 force application all&#39;&quot;             &amp;&amp; success || failure &amp;
    sleep 5
    initlog -c &quot;/bin/su - $USER -c             &#39;db2stop force&#39;&quot; &amp;&amp; success             || failure &amp;
    sleep 5
    initlog -c &quot;/bin/su - $USER -c             &#39;db2_kill&#39;&quot; &amp;&amp; success             || failure &amp;
    echo &quot;&quot;
fi
</code></pre>

<p>}</p>

<p>case &quot;$1&quot; in
 start)
   start
        ;;
 stop)
        stop 
        ;;</p>

<p>status)
        status
        ;;</p>

<p>restart)
   stop
        sleep 3
   start
        ;;
 *)
    echo $&quot;Usage: $0 {start|stop|restart}&quot;
    RETVAL=1
    ;;
esac</p>

<p>exit $RETVAL</p>



            </article>
        </main>

        <ul class="pager">
            <li class="prev">
                <a class="button disabled" href="" rel="next">
                    ← Older
                </a>
            </li>
            <li class="next">
                <a class="button disabled" href="" rel="prev">
                    Newer →
                </a>
            </li>
        </ul>

    </div>

    <div class="three columns sidebar">
        
        <h1>Tags</h1>
        <ul class="list-inline">
            <li><a href="/blog/tag/CFEngine/">CFEngine</a></li>
            <li><a href="/blog/tag/apt/">apt</a></li>
            <li><a href="/blog/tag/backup/">backup</a></li>
            <li><a href="/blog/tag/cfengine/">cfengine</a></li>
            <li><a href="/blog/tag/cfengine-cookbook/">cfengine cookbook</a></li>
            <li><a href="/blog/tag/cheatsheet/">cheatsheet</a></li>
            <li><a href="/blog/tag/cli/">cli</a></li>
            <li><a href="/blog/tag/cluster/">cluster</a></li>
            <li><a href="/blog/tag/configuration-management/">configuration management</a></li>
            <li><a href="/blog/tag/cron/">cron</a></li>
            <li><a href="/blog/tag/debian/">debian</a></li>
            <li><a href="/blog/tag/dns/">dns</a></li>
            <li><a href="/blog/tag/dr/">dr</a></li>
            <li><a href="/blog/tag/heartbeat/">heartbeat</a></li>
            <li><a href="/blog/tag/high-availability/">high availability</a></li>
            <li><a href="/blog/tag/infosec/">infosec</a></li>
            <li><a href="/blog/tag/ipv6/">ipv6</a></li>
            <li><a href="/blog/tag/iscsi/">iscsi</a></li>
            <li><a href="/blog/tag/kvm/">kvm</a></li>
            <li><a href="/blog/tag/linux/">linux</a></li>
            <li><a href="/blog/tag/monitoring/">monitoring</a></li>
            <li><a href="/blog/tag/multipathd/">multipathd</a></li>
            <li><a href="/blog/tag/networking/">networking</a></li>
            <li><a href="/blog/tag/opensource/">opensource</a></li>
            <li><a href="/blog/tag/oracle/">oracle</a></li>
            <li><a href="/blog/tag/posix/">posix</a></li>
            <li><a href="/blog/tag/red-hat/">red hat</a></li>
            <li><a href="/blog/tag/regex/">regex</a></li>
            <li><a href="/blog/tag/rhev/">rhev</a></li>
            <li><a href="/blog/tag/san/">san</a></li>
            <li><a href="/blog/tag/shell/">shell</a></li>
            <li><a href="/blog/tag/solaris/">solaris</a></li>
            <li><a href="/blog/tag/ssh/">ssh</a></li>
            <li><a href="/blog/tag/subversion/">subversion</a></li>
            <li><a href="/blog/tag/sun/">sun</a></li>
            <li><a href="/blog/tag/support/">support</a></li>
            <li><a href="/blog/tag/svn/">svn</a></li>
            <li><a href="/blog/tag/sysadmin/">sysadmin</a></li>
            <li><a href="/blog/tag/vitualization/">vitualization</a></li>
        </ul>
        <h1>Feeds</h1>
        <ul class="list-inline">
            <li>
                <a href="/blog/tag/red-hat.atom" rel="alternate" type="application/atom+xml">
                    Atom
                </a>
            </li>
            <li>
                <a href="/blog/tag/red-hat.rss" rel="alternate" type="application/rss+xml">
                    RSS
                </a>
            </li>
        </ul>
    </div>

</div>


        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
