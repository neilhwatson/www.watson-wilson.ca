<!DOCTYPE html>
<html>
    <head>
        <link href="/theme/css/normalize.css" rel="stylesheet">
        <link href="/theme/css/skeleton.css" rel="stylesheet">
        <link href="/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Dynamic bundlesequence in Cfengine - Neil H. Watson</title>
        <meta content="Statocles 0.059" name="generator">
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">Neil H. Watson</a>
                    <ul>
                        <li>
                            <a href="/">Blog</a>
                        </li>
                    </ul>
                    
                </div>
            </nav>
            
        </header>
        <div class="main container">
            <div class="row">

    <div class="nine columns">
        <main>
            <header>
                <h1>Dynamic bundlesequence in Cfengine</h1>
                <p class="tags">Tags:
                    <a href="/blog/tag/cfengine/" rel="tag">cfengine</a>
                    <a href="/blog/tag/cfengine-cookbook/" rel="tag">cfengine cookbook</a>
                    <a href="/blog/tag/configuration-management/" rel="tag">configuration management</a>
                </p>

                <aside>
                    <p><time datetime="2011-09-16">
                        Posted on 2011-09-16
                    </time>
                    </p>
                </aside>


            </header>
            <section id="section-1">
                <p>Problem</p>

<p>You want to have your bundlesequence change based on class.</p>

<p>Solution</p>

<p>This question comes up regularly on the Cfengine mailing list. The secret is to build a string list based on class. The alternative is to use methods.</p>

<p>bundle common g {
    vars:</p>

<pre><code>    any::

        &quot;bseq&quot; slist =&gt; {
            &quot;site&quot;,
            &quot;ntp&quot;,
            &quot;hard&quot;
        },
        policy =&gt; &quot;free&quot;;

    cf_dbs::

        &quot;bseq&quot; slist =&gt; {
            @{bseq},
            &quot;db2&quot;,
            &quot;mysql&quot;
        },
        policy =&gt; &quot;free&quot;;

    cf_webfarm::

        &quot;bseq&quot; slist =&gt; {
            @{bseq},
            &quot;httpd&quot;,
            &quot;proxy&quot;
        },
        policy =&gt; &quot;free&quot;;
</code></pre>

<p>}</p>

<p>body common control {</p>

<pre><code>bundlesequence =&gt; { &quot;@{g.bseq}&quot; };
</code></pre>

<p>}</p>

<p>bundle agent site{
    reports:
        cfengine_3::
            &quot;site bundle&quot;;
}
bundle agent ntp{
    reports:
        cfengine_3::
            &quot;ntp bundle&quot;;
}
bundle agent hard{
    reports:
        cfengine_3::
            &quot;hard bundle&quot;;
}
bundle agent db2{
    reports:
        cfengine_3::
            &quot;db2 bundle&quot;;
}
bundle agent mysql{
    reports:
        cfengine_3::
            &quot;mysql bundle&quot;;
}
bundle agent httpd{
        reports:
            cfengine_3::
                &quot;httpd bundle&quot;;
}
bundle agent proxy{
        reports:
            cfengine_3::
                &quot;proxy bundle&quot;;
}</p>

<p>Although left out here for brevity, under normal conditions you would have a classes section in the common g bundle to define what hosts belong to the classes cf_dbs and cf_webfarm. In the vars section you can see how we build upon the default bseq list first defined for the any class. The policy body part allows us to redefine the variable. By default Cfengine does not allow variable values to be changed.</p>

<p>Please note that due to normal ordering vars promises are evaluated before classes promises. So the custom classes cf_dbs and cf_webfarm must be declared in a common bundle above the common g bundle. For example:</p>

<p>bundle common classes {
   classes:</p>

<pre><code>  &quot;cf_dbs&quot; or =&gt; { &quot;hosta&quot;, &quot;hostb&quot;, &quot;hostc&quot; };
</code></pre>

<p>}
bundle common g {
    vars:</p>

<pre><code>    any::

        &quot;bseq&quot; slist =&gt; {
            &quot;site&quot;,
            &quot;ntp&quot;,
            &quot;hard&quot;
        },
        policy =&gt; &quot;free&quot;;

    cf_dbs::

        &quot;bseq&quot; slist =&gt; {
            @{bseq},
            &quot;db2&quot;,
            &quot;mysql&quot;
        },
        policy =&gt; &quot;free&quot;;
</code></pre>

<p>..</p>

<p>For this exercise we can set the classes manually using the -D command switch. Below you can see how the bundle sequence changes for each class starting with the default any class.</p>

<p>neil@ettin ~/.cfagent/inputs $ cf-agent -f ./recipe.cf
R: site bundle
R: ntp bundle
R: hard bundle
neil@ettin ~/.cfagent/inputs $ cf-agent -KD cf_dbs -f ./recipe.cf
R: site bundle
R: ntp bundle
R: hard bundle
R: db2 bundle
R: mysql bundle
neil@ettin ~/.cfagent/inputs $ cf-agent -KD cf_webfarm -f ./recipe.cf
R: site bundle
R: ntp bundle
R: hard bundle
R: httpd bundle
R: proxy bundle</p>

<p>People do this with inputs too. If your inputs holds secret information like passwords this can be useful.</p>

<p>An alternative method to a dynamic bundle sequence is to use methods.</p>

<p>body common control {</p>

<pre><code>bundlesequence =&gt; { &quot;main&quot; };
</code></pre>

<p>}</p>

<p>bundle agent main{</p>

<pre><code>methods:

    any::

        &quot;any&quot; usebundle =&gt; site;
        &quot;any&quot; usebundle =&gt; ntp;
        &quot;any&quot; usebundle =&gt; hard;

    cf_dbs::

        &quot;cf_dbs&quot; usebundle =&gt; db2;
        &quot;cf_dbs&quot; usebundle =&gt; mysql;

    cf_webfarm::

        &quot;cf_dbs&quot; usebundle =&gt; httpd;
        &quot;cf_dbs&quot; usebundle =&gt; proxy;
</code></pre>

<p>}</p>

<p>bundle agent site{
    reports:
        cfengine_3::
            &quot;site bundle&quot;;
}
bundle agent ntp{
    reports:
        cfengine_3::
            &quot;ntp bundle&quot;;
}
bundle agent hard{
    reports:
        cfengine_3::
            &quot;hard bundle&quot;;
}
bundle agent db2{
    reports:
        cfengine_3::
            &quot;db2 bundle&quot;;
}
bundle agent mysql{
    reports:
        cfengine_3::
            &quot;mysql bundle&quot;;
}
bundle agent httpd{
        reports:
            cfengine_3::
                &quot;httpd bundle&quot;;
}
bundle agent proxy{
        reports:
            cfengine_3::
                &quot;proxy bundle&quot;;
}</p>

<p>The result is exactly the same. However using methods allows you to pass parameters to the bundles. Also you can define your classes for cf_dbs and cf_webfarms in the same main bundle. For example:</p>

<p>body common control {</p>

<pre><code>bundlesequence =&gt; { &quot;main&quot; };
</code></pre>

<p>}
bundle agent main{</p>

<pre><code>vars:

    cf_dbs1::

        &quot;db2_version&quot; string =&gt; &quot;9.1&quot;;

    cf_dbs2::

        &quot;db2_version&quot; string =&gt; &quot;9.2&quot;;

classes:

    &quot;cf_dbs1&quot; or =&gt; { &quot;dbhost1&quot;, &quot;dbhost2&quot;, &quot;dbhost3&quot; };
    &quot;cf_dbs2&quot; or =&gt; { &quot;dbhost4&quot;, &quot;dbhost5&quot;, &quot;dbhost6&quot; };
    &quot;cf_dbs&quot; or =&gt; { &quot;cf_dbs1&quot;, &quot;cf_dbs2&quot; };

methods:

    any::

        &quot;any&quot; usebundle =&gt; site;
        &quot;any&quot; usebundle =&gt; ntp;
        &quot;any&quot; usebundle =&gt; hard;

    cf_dbs::

        &quot;cf_dbs&quot; usebundle =&gt; db2( &quot;${db2_version}&quot; );
        &quot;cf_dbs&quot; usebundle =&gt; mysql;
</code></pre>

<p>}</p>

<p>bundle agent site{
    reports:
        cfengine_3::
            &quot;site bundle&quot;;
}
bundle agent ntp{
    reports:
        cfengine_3::
            &quot;ntp bundle&quot;;
}
bundle agent hard{
    reports:
        cfengine_3::
            &quot;hard bundle&quot;;
}
bundle agent db2(version){
    reports:
        cfengine_3::
            &quot;db2 bundle ${version}&quot;;
}
bundle agent mysql{
    reports:
        cfengine_3::
            &quot;mysql bundle&quot;;
}</p>

<p>Here we define groups of database host classes. Hosts with the hostname dbhost1 to dbhost3 are members of the cf_dbs1 class. Members of that class have the db2_version string set to 9.1. Using classes we not only determine which bundles are run but what parameters can be passed to them.</p>

<p>neil@ettin ~/.cfagent/inputs $ cf-agent -Kf ./recipe.cf
R: site bundle
R: ntp bundle
R: hard bundle
neil@ettin ~/.cfagent/inputs $ cf-agent -D dbhost1 -Kf ./recipe.cf
R: site bundle
R: ntp bundle
R: hard bundle
R: db2 bundle 9.1
R: mysql bundle
neil@ettin ~/.cfagent/inputs $ cf-agent -D dbhost4 -Kf ./recipe.cf
R: site bundle
R: ntp bundle
R: hard bundle
R: db2 bundle 9.2
R: mysql bundle</p>

            </section>
        </main>


    </div>

    <div class="three columns sidebar">
        
        <nav id="tags">
            <h1>Tags</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/apt/">apt</a></li>
                <li><a href="/blog/tag/backup/">backup</a></li>
                <li><a href="/blog/tag/cfengine/">cfengine</a></li>
                <li><a href="/blog/tag/cfengine-cookbook/">cfengine cookbook</a></li>
                <li><a href="/blog/tag/cheatsheet/">cheatsheet</a></li>
                <li><a href="/blog/tag/cli/">cli</a></li>
                <li><a href="/blog/tag/cluster/">cluster</a></li>
                <li><a href="/blog/tag/configuration-management/">configuration management</a></li>
                <li><a href="/blog/tag/cron/">cron</a></li>
                <li><a href="/blog/tag/debian/">debian</a></li>
                <li><a href="/blog/tag/dns/">dns</a></li>
                <li><a href="/blog/tag/dr/">dr</a></li>
                <li><a href="/blog/tag/heartbeat/">heartbeat</a></li>
                <li><a href="/blog/tag/high-availability/">high availability</a></li>
                <li><a href="/blog/tag/infosec/">infosec</a></li>
                <li><a href="/blog/tag/ipv6/">ipv6</a></li>
                <li><a href="/blog/tag/iscsi/">iscsi</a></li>
                <li><a href="/blog/tag/kvm/">kvm</a></li>
                <li><a href="/blog/tag/linux/">linux</a></li>
                <li><a href="/blog/tag/monitoring/">monitoring</a></li>
                <li><a href="/blog/tag/multipathd/">multipathd</a></li>
                <li><a href="/blog/tag/networking/">networking</a></li>
                <li><a href="/blog/tag/opensource/">opensource</a></li>
                <li><a href="/blog/tag/oracle/">oracle</a></li>
                <li><a href="/blog/tag/posix/">posix</a></li>
                <li><a href="/blog/tag/red-hat/">red hat</a></li>
                <li><a href="/blog/tag/regex/">regex</a></li>
                <li><a href="/blog/tag/rhev/">rhev</a></li>
                <li><a href="/blog/tag/san/">san</a></li>
                <li><a href="/blog/tag/shell/">shell</a></li>
                <li><a href="/blog/tag/solaris/">solaris</a></li>
                <li><a href="/blog/tag/ssh/">ssh</a></li>
                <li><a href="/blog/tag/subversion/">subversion</a></li>
                <li><a href="/blog/tag/sun/">sun</a></li>
                <li><a href="/blog/tag/support/">support</a></li>
                <li><a href="/blog/tag/svn/">svn</a></li>
                <li><a href="/blog/tag/sysadmin/">sysadmin</a></li>
                <li><a href="/blog/tag/vitualization/">vitualization</a></li>
            </ul>
        </nav>
    </div>

</div>

        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.github.io/Statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
