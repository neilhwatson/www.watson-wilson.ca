<!DOCTYPE html>
<html lang="en"> 
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/theme/css/readability-bootstrap.min.css" />
        <!--<link rel="stylesheet" href="/theme/css/statocles-bootstrap.css" />-->
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <title>EFL tech preview for JSON parameters - Neil H. Watson</title>
        <meta name="generator" content="Statocles 0.094" />
        

        <!-- Twitter for websites -->
         <script>window.twttr = (function(d, s, id) {
           var js, fjs = d.getElementsByTagName(s)[0],
             t = window.twttr || {};
           if (d.getElementById(id)) return t;
           js = d.createElement(s);
           js.id = id;
           js.src = "https://platform.twitter.com/widgets.js";
           fjs.parentNode.insertBefore(js, fjs);

           t._e = [];
           t.ready = function(f) {
             t._e.push(f);
           };

           return t;
         }(document, "script", "twitter-wjs"));</script>

        <!-- For source highlighting -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/default.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
        <header>
            <nav class="navbar navbar-default navbar-static-top" role="navigation">
                <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#top-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Neil H. Watson</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="/page/about">About me</a></li>
                            <li><a href="/static/resume_neil_h_watson.pdf">Resume</a></li>
                            <li><a href="/page/projects">Projects</a></li>
                            <li><a href="/page/evolvethinking">UPDATE: EvolveThinking</a></li>
                        </ul>
                        
                    </div>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            <div class="row">

    <div class="col-md-9">
        <main>
            <header>
                <h1>EFL tech preview for JSON parameters</h1>
                <p class="tags">Tags:
                    <a href="/blog/tag/cfengine/" rel="tag">cfengine</a>
                    <a href="/blog/tag/efl/" rel="tag">EFL</a>
                </p>

                <aside>
                    <p><time datetime="2014-10-02">
                        Posted on 2014-10-02
                    </time>
                        by nwatson
                    </p>
                </aside>


            </header>
            <section id="section-1">
                <p>It's very likely that <a href="https://github.com/neilhwatson/evolve_cfengine_freelib">EFL</a>
for CFEngine 3.6 will be able to read both CSV and JSON parameter
files. Some EFL users are looking forward to this because some CSV
files have very long lines and are hard to read. On the other hand some
CSV files are short and less cluttered than an equivalent JSON file
would be. At first I tried to transition completely to JSON files, but
upon further consideration EFL will be able to use both. Here's how.</p>

            </section>
            <section id="section-2">
                <p>The following example creates a CSV and a JSON parameter file with the
same parameters in each, then parses them similar to the current <em>efl_command
bundle</em>. The bundle efl_command takes the same input as you are using
now, or a JSON file.</p>

<p>Current CSV parameters</p>

<pre><code>any   ;; /usr/bin/true  ;; no  ;; no  ;; 1  ;; promisee for true
# comments more flexible in csv.
linux ;; /usr/bin/false ;; yes ;; yes ;; 60 ;; promisee for false
</code></pre>

<p>Upcoming JSON parameters</p>

<pre><code>[
   {
      "class": "any",
      "command": "/usr/bin/true",
      "useshell": "no",
      "comment": "This is how comments must be in JSON",
      "module": "no",
      "ifelapsed": 1,
      "promisee": "promisee for true"
   },
   {
      "class": "linux",
      "command": "/usr/bin/false",
      "useshell": "yes",
      "module": "yes",
      "ifelapsed": 60,
      "promisee": "promisee for false"
   }
]
</code></pre>

<p>The bundle efl_command will call an additional bundle to parse the
parameter file, but to the you efl_command will work exactly the same
way. You won't have to change your parameter files to transition from
3.5 to 3.6.</p>

<p>Preview policy</p>

<pre><code>body common control
{
        bundlesequence =&gt; { "main", };
}

bundle agent main
{
   methods:
      "create param files for example" usebundle =&gt; init( 'testfile' );

      parse_json::
         "json"
            usebundle =&gt; efl_command( "${sys.workdir}/inputs/testfile.json" );

      parse_csv::
         "csv"
            usebundle =&gt; efl_command( "${sys.workdir}/inputs/testfile.csv" );
}

bundle agent efl_command( ref )
{
   meta:
      "purpose" string =&gt; "Run given command if context is true.";
      "field_0" string =&gt; "Context";
      "field_1" string =&gt; "Command";
      "field_2" string =&gt; "usehell";
      "field_3" string =&gt; "module";
      "field_4" string =&gt; "ifelapsed";
      "field_5" string =&gt; "promisee";

   vars:
      "p"
         comment =&gt; "Prefix to call fq var names from method call bundle",
         string  =&gt; "efl_command_parse";

   methods:
      'parse data'
         inherit   =&gt; 'true',
         usebundle =&gt; efl_command_parse( "${ref}" );

## Demonstrate that command parameters are parsed without 
## using an actual commands promise
   reports:
   '
   "${${p}.command[${${p}.i}]}" -&gt; { "${${p}.promisee[${${p}.i}]}" }
      comment    =&gt; "Run desired command",
      handle     =&gt; "efl_command_commands",
      ifvarclass =&gt; "${${p}.class[${${p}.i}]}",
      contain    =&gt; contain_efl_command( "${${p}.useshell[${${p}.i}]}" ),
      module     =&gt; "${${p}.module[${${p}.i}]}",
      classes    =&gt; efl_rkn( "${${p}.command[${${p}.i}]}",
         "efl_command_commands" ),
      action     =&gt; efl_delta_reporting( "efl_command_commands",
         "${${p}.command[${${p}.i}]}", "${${p}.promisee[${${p}.i}]}",
         "${${p}.ifelapsed[${${p}.i}]}"); ';
}

bundle agent efl_command_parse ( ref )
{
   meta:
      'purpose' string =&gt; "Parse data for efl_command via method.";
      'note'    string =&gt; "Using a method avoids the loss of a pass.";

   vars:
      "ref_canon" string =&gt; canonify( "${ref}" );

## Pasrse CSV files
      "cmd_o"
         comment    =&gt; "Read data file for parsing.",
         ifvarclass =&gt; "parse_${ref_canon}_as_csv" ,
         data       =&gt; data_readstringarrayidx(
            "${ref}",
            "${efl_c.comment}",
            "${efl_c.array_delimiter}",
            "${efl_c.max_num}",
            "${efl_c.max_bytes}"
         );

## Pasrse JSON files
      "cmd_o"
         ifvarclass =&gt; "parse_${ref_canon}_as_json" ,
         data       =&gt; readjson( "${ref}", "${efl_c.max_bytes}" );

      "i"
         ifvarclass =&gt; "parse_${ref_canon}_as_json|parse_${ref_canon}_as_csv",
         slist      =&gt; getindices( "cmd_o" );

## Build final common data array for bundle use and expand internal vars
## to work around bug 2333
      "class[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_csv",
         string     =&gt; "${cmd_o[${i}][0]}";
      "class[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_json",
         string     =&gt; "${cmd_o[${i}][class]}";
      "command[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_csv",
         string     =&gt; "${cmd_o[${i}][1]}";
      "command[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_json",
         string     =&gt; "${cmd_o[${i}][command]}";
      "useshell[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_csv",
         string     =&gt; "${cmd_o[${i}][2]}";
      "useshell[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_json",
         string     =&gt; "${cmd_o[${i}][useshell]}";
      "module[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_csv",
         string     =&gt; "${cmd_o[${i}][3]}";
      "module[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_json",
         string     =&gt; "${cmd_o[${i}][module]}";
      "ifelapsed[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_csv",
         string     =&gt; "${cmd_o[${i}][4]}";
      "ifelapsed[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_json",
         string     =&gt; "${cmd_o[${i}][ifelapsed]}";
      "promisee[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_csv",
         string     =&gt; "${cmd_o[${i}][5]}";
      "promisee[${i}]"
         ifvarclass =&gt; "parse_${ref_canon}_as_json",
         string     =&gt; "${cmd_o[${i}][promisee]}";

   classes:
      "parse_${ref_canon}_as_json"
         expression =&gt; regcmp( ".*\.(json|dat|jsn)", ${ref} );
      "parse_${ref_canon}_as_csv"
         expression =&gt; regcmp( ".*\.(txt|csv)", ${ref} );
}

bundle agent init ( ref )
{
   meta:
      'purpose' string =&gt; "Promise json and csv files for this demonstration";

   vars:
      "${ref}_contents[json]" string =&gt; '
[
   {
      "class": "any",
      "command": "/usr/bin/true",
      "useshell": "no",
      "comment": "This is how comments must be in JSON",
      "module": "no",
      "ifelapsed": 1,
      "promisee": "promisee for true"
   },
   {
      "class": "linux",
      "command": "/usr/bin/false",
      "useshell": "yes",
      "module": "yes",
      "ifelapsed": 60,
      "promisee": "promisee for false"
   }
]';
      "${ref}_contents[csv]" string =&gt; "
any ;; /usr/bin/true ;; no ;; no ;; 1 ;; promisee for true
# comments more flexible in csv.
linux ;; /usr/bin/false ;; yes ;; yes ;; 60 ;; promisee for false
";

   "i" slist =&gt; getindices( '${ref}_contents' );

   files:
      "${sys.workdir}/inputs/${ref}.${i}" -&gt; { "Neil H Watson", "EFL" }
         create        =&gt; 'true',
         edit_defaults =&gt; empty,
         edit_line     =&gt; append_if_no_line( "${${ref}_contents[${i}]}" );
}

body edit_defaults empty
{
      empty_file_before_editing =&gt; "true";
      edit_backup =&gt; "false";
}
bundle edit_line append_if_no_line(str)
{
  insert_lines:
      "$(str)";
}

bundle common efl_c
{
   meta:
      "purpose" string =&gt; "Common configs for all EFL bundles";

   vars:
#
# Configs for reading data files
#
      "cache"
         comment =&gt; "Location for agent to cache template and other temp files",
         string  =&gt; "/var/cache/cfengine";

      "class"
         comment =&gt; "Regex to extract class name from parameter file name.",
         string  =&gt; ".*?-(\w+)\.txt";

      "comment"
         comment =&gt; "Comment string in data file.",
         string  =&gt; "\s*#[^\n]*";

      "array_delimiter"
         comment =&gt; "Field delimiter for CSV data files read by readstringarrayidx",
         string  =&gt; "\s*;;\s*";

      "slist_delimiter"
         comment =&gt; "Field delimiter for CSV data files read by readstringlist",
         string  =&gt; "\s";

      "max_num"
         comment =&gt; "Maximum number of lines to read from data file",
         int     =&gt; "500";

      "max_bytes"
         comment =&gt; "Maximum number of bytes to read from data file.",
         string  =&gt; "1M";

}
</code></pre>

<p>Policy in action <code></code></p>

<pre><code>neil@ettin ~/.cfagent/inputs $ cf-agent -Kf ./efl36.cf -D parse_csv
R: 
   "/usr/bin/true" -&gt; { "promisee for true" }
      comment    =&gt; "Run desired command",
      handle     =&gt; "efl_command_commands",
      ifvarclass =&gt; "any",
      contain    =&gt; contain_efl_command( "no" ),
      module     =&gt; "no",
      classes    =&gt; efl_rkn( "/usr/bin/true",
         "efl_command_commands" ),
      action     =&gt; efl_delta_reporting( "efl_command_commands",
         "/usr/bin/true", "promisee for true",
         "1"); 
R: 
   "/usr/bin/false" -&gt; { "promisee for false" }
      comment    =&gt; "Run desired command",
      handle     =&gt; "efl_command_commands",
      ifvarclass =&gt; "linux",
      contain    =&gt; contain_efl_command( "yes" ),
      module     =&gt; "yes",
      classes    =&gt; efl_rkn( "/usr/bin/false",
         "efl_command_commands" ),
      action     =&gt; efl_delta_reporting( "efl_command_commands",
         "/usr/bin/false", "promisee for false",
         "60"); 

neil@ettin ~/.cfagent/inputs $ cf-agent -Kf ./efl36.cf -D parse_json
R: 
   "/usr/bin/true" -&gt; { "promiser for true" }
      comment    =&gt; "Run desired command",
      handle     =&gt; "efl_command_commands",
      ifvarclass =&gt; "any",
      contain    =&gt; contain_efl_command( "no" ),
      module     =&gt; "no",
      classes    =&gt; efl_rkn( "/usr/bin/true",
         "efl_command_commands" ),
      action     =&gt; efl_delta_reporting( "efl_command_commands",
         "/usr/bin/true", "promiser for true",
         "1"); 
R: 
   "/usr/bin/false" -&gt; { "promiser for false" }
      comment    =&gt; "Run desired command",
      handle     =&gt; "efl_command_commands",
      ifvarclass =&gt; "linux",
      contain    =&gt; contain_efl_command( "yes" ),
      module     =&gt; "yes",
      classes    =&gt; efl_rkn( "/usr/bin/false",
         "efl_command_commands" ),
      action     =&gt; efl_delta_reporting( "efl_command_commands",
         "/usr/bin/false", "promiser for false",
         "60"); 
</code></pre>

<p>Once CFEngine 3.6 stabilizes look for updates in <a href="https://github.com/neilhwatson/evolve_cfengine_freelib">EFL</a>.
In the mean time I recommend you stick with EFL's 3.5 branch and
CFEngine 3.5.</p>

            </section>
        </main>


    </div>

    <div class="col-md-3">
        <iframe src="https://duckduckgo.com/search.html?site=watson-wilson.ca&prefill=Search DuckDuckGo" style="overflow:hidden;margin:0;padding:0;width:350px;height:40px;" frameborder="0"></iframe>

        <nav id="tags">
            <h1>Tags</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/ansible/">ansible</a></li>
                <li><a href="/blog/tag/anti-virus/">anti-virus</a></li>
                <li><a href="/blog/tag/apt/">apt</a></li>
                <li><a href="/blog/tag/asg/">asg</a></li>
                <li><a href="/blog/tag/autoscaling/">autoscaling</a></li>
                <li><a href="/blog/tag/aws/">AWS</a></li>
                <li><a href="/blog/tag/azure/">azure</a></li>
                <li><a href="/blog/tag/backup/">backup</a></li>
                <li><a href="/blog/tag/best-practices/">best practices</a></li>
                <li><a href="/blog/tag/bitbucket/">bitbucket</a></li>
                <li><a href="/blog/tag/bosh/">bosh</a></li>
                <li><a href="/blog/tag/cfengine/">cfengine</a></li>
                <li><a href="/blog/tag/cfengine-cookbook/">cfengine cookbook</a></li>
                <li><a href="/blog/tag/cheatsheet/">cheatsheet</a></li>
                <li><a href="/blog/tag/cli/">cli</a></li>
                <li><a href="/blog/tag/cloud/">cloud</a></li>
                <li><a href="/blog/tag/cloud-foundry/">cloud foundry</a></li>
                <li><a href="/blog/tag/cluster/">cluster</a></li>
                <li><a href="/blog/tag/conferences/">conferences</a></li>
                <li><a href="/blog/tag/configuration-management/">configuration management</a></li>
                <li><a href="/blog/tag/containers/">containers</a></li>
                <li><a href="/blog/tag/continuous-integration/">continuous integration</a></li>
                <li><a href="/blog/tag/cron/">cron</a></li>
                <li><a href="/blog/tag/debian/">debian</a></li>
                <li><a href="/blog/tag/delta-reporting/">delta reporting</a></li>
                <li><a href="/blog/tag/devops/">devops</a></li>
                <li><a href="/blog/tag/dns/">dns</a></li>
                <li><a href="/blog/tag/docker/">docker</a></li>
                <li><a href="/blog/tag/dr/">dr</a></li>
                <li><a href="/blog/tag/efl/">EFL</a></li>
                <li><a href="/blog/tag/ergonomics/">ergonomics</a></li>
                <li><a href="/blog/tag/github/">github</a></li>
                <li><a href="/blog/tag/heartbeat/">heartbeat</a></li>
                <li><a href="/blog/tag/high-availability/">high availability</a></li>
                <li><a href="/blog/tag/infosec/">infosec</a></li>
                <li><a href="/blog/tag/ipv6/">ipv6</a></li>
                <li><a href="/blog/tag/irc/">irc</a></li>
                <li><a href="/blog/tag/iscsi/">iscsi</a></li>
                <li><a href="/blog/tag/jekyll/">jekyll</a></li>
                <li><a href="/blog/tag/jq/">jq</a></li>
                <li><a href="/blog/tag/json/">json</a></li>
                <li><a href="/blog/tag/keyboard/">keyboard</a></li>
                <li><a href="/blog/tag/kickstart/">kickstart</a></li>
                <li><a href="/blog/tag/kvm/">kvm</a></li>
                <li><a href="/blog/tag/lambda/">lambda</a></li>
                <li><a href="/blog/tag/linux/">linux</a></li>
                <li><a href="/blog/tag/markdown/">markdown</a></li>
                <li><a href="/blog/tag/monitoring/">monitoring</a></li>
                <li><a href="/blog/tag/multipathd/">multipathd</a></li>
                <li><a href="/blog/tag/mustache/">mustache</a></li>
                <li><a href="/blog/tag/networking/">networking</a></li>
                <li><a href="/blog/tag/opennms/">opennms</a></li>
                <li><a href="/blog/tag/opensource/">opensource</a></li>
                <li><a href="/blog/tag/oracle/">oracle</a></li>
                <li><a href="/blog/tag/orchestration/">orchestration</a></li>
                <li><a href="/blog/tag/patching/">patching</a></li>
                <li><a href="/blog/tag/pcre/">pcre</a></li>
                <li><a href="/blog/tag/perl/">perl</a></li>
                <li><a href="/blog/tag/posix/">posix</a></li>
                <li><a href="/blog/tag/programming/">programming</a></li>
                <li><a href="/blog/tag/provisioning/">provisioning</a></li>
                <li><a href="/blog/tag/python/">python</a></li>
                <li><a href="/blog/tag/red-hat/">red hat</a></li>
                <li><a href="/blog/tag/redhat/">redhat</a></li>
                <li><a href="/blog/tag/regex/">regex</a></li>
                <li><a href="/blog/tag/rhev/">rhev</a></li>
                <li><a href="/blog/tag/ruby/">ruby</a></li>
                <li><a href="/blog/tag/san/">san</a></li>
                <li><a href="/blog/tag/satellite/">satellite</a></li>
                <li><a href="/blog/tag/scripting/">scripting</a></li>
                <li><a href="/blog/tag/security/">security</a></li>
                <li><a href="/blog/tag/serverless/">serverless</a></li>
                <li><a href="/blog/tag/serverspec/">serverspec</a></li>
                <li><a href="/blog/tag/shell/">shell</a></li>
                <li><a href="/blog/tag/slaac/">slaac</a></li>
                <li><a href="/blog/tag/software-testing/">software testing</a></li>
                <li><a href="/blog/tag/solaris/">solaris</a></li>
                <li><a href="/blog/tag/spacewalk/">spacewalk</a></li>
                <li><a href="/blog/tag/ssh/">ssh</a></li>
                <li><a href="/blog/tag/statocles/">statocles</a></li>
                <li><a href="/blog/tag/subnet/">subnet</a></li>
                <li><a href="/blog/tag/subversion/">subversion</a></li>
                <li><a href="/blog/tag/sun/">sun</a></li>
                <li><a href="/blog/tag/support/">support</a></li>
                <li><a href="/blog/tag/svn/">svn</a></li>
                <li><a href="/blog/tag/sysadmin/">sysadmin</a></li>
                <li><a href="/blog/tag/sysctl/">sysctl</a></li>
                <li><a href="/blog/tag/terraform/">terraform</a></li>
                <li><a href="/blog/tag/virus/">virus</a></li>
                <li><a href="/blog/tag/vitualization/">vitualization</a></li>
                <li><a href="/blog/tag/website/">website</a></li>
                <li><a href="/blog/tag/yaml/">yaml</a></li>
                <li><a href="/blog/tag/yamllint/">yamllint</a></li>
            </ul>
        </nav>
    </div>

</div>

<div class='row'>
   <div class='col-md-1'>
       <img atl='Neil Watson' src='https://gravatar.com/avatar/1f0969599955a953e592034929ed7a23' >
   </div>

       <div class='col-md-1'>
            <!-- reddit this -->
            <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false"><img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /></a>
       </div>

       <div class='col-md-1'>
          <!-- Tweet this -->
          <a class="twitter-share-button"
             href="https://twitter.com/intent/tweet">
          Tweet</a>
       </div>

       <div class='col-md-1'>
          <!-- follow me on twitter -->
         <a class="twitter-follow-button"
            data-show-count="false"
            data-show-screen-name="false"
           href="https://twitter.com/neil_h_watson">
         Follow @neil_h_watson</a>
        </div>

       <div class='col-md-1'>
           <!-- follw me on github -->
            <a aria-label="Follow @neilhwatson on GitHub" data-style="mega" href="https://github.com/neilhwatson" class="github-button">Follow</a>
            <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
       </div>

</div>

        </div>
        <footer>
            
            <h1></h1>
            <div class='col-md-5'> </div>
            <div class="col-md-3 container tagline">
                <a href="http://preaction.me/statocles">Made with Statocles</a><br/>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
