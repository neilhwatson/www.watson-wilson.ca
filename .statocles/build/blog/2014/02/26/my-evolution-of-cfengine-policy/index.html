<!DOCTYPE html>
<html lang="en"> 
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/theme/css/readability-bootstrap.min.css" />
        <!--<link rel="stylesheet" href="/theme/css/statocles-bootstrap.css" />-->
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <title>My evolution of CFEngine policy - Neil H. Watson</title>
        <meta name="generator" content="Statocles 0.094" />
        

        <!-- Twitter for websites -->
         <script>window.twttr = (function(d, s, id) {
           var js, fjs = d.getElementsByTagName(s)[0],
             t = window.twttr || {};
           if (d.getElementById(id)) return t;
           js = d.createElement(s);
           js.id = id;
           js.src = "https://platform.twitter.com/widgets.js";
           fjs.parentNode.insertBefore(js, fjs);

           t._e = [];
           t.ready = function(f) {
             t._e.push(f);
           };

           return t;
         }(document, "script", "twitter-wjs"));</script>

        <!-- For source highlighting -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/default.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
        <header>
            <nav class="navbar navbar-default navbar-static-top" role="navigation">
                <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#top-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Neil H. Watson</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="/page/about">About me</a></li>
                            <li><a href="/static/resume_neil_h_watson.pdf">Resume</a></li>
                            <li><a href="/page/projects">Projects</a></li>
                            <li><a href="/page/evolvethinking">UPDATE: EvolveThinking</a></li>
                        </ul>
                        
                    </div>
                </div>
            </nav>
            
        </header>
        <div class="main container">
            <div class="row">

    <div class="col-md-9">
        <main>
            <header>
                <h1>My evolution of CFEngine policy</h1>
                <p class="tags">Tags:
                    <a href="/blog/tag/cfengine/" rel="tag">cfengine</a>
                    <a href="/blog/tag/efl/" rel="tag">EFL</a>
                </p>

                <aside>
                    <p><time datetime="2014-02-26">
                        Posted on 2014-02-26
                    </time>
                        by nwatson
                    </p>
                </aside>


            </header>
            <section id="section-1">
                <p><img src="/static/images/fire-240.jpg" alt="Evolution of fire" /></p>

<p>My style and approach to CFEngine policy writing has evolved over the
years. Recently I discussion this with someone new to CFEngine. He was
on the same path I had taken, but a few steps behind. I hope he'll
evolve to the next stage or to a stage that is new to both of us. I'm
going to share with you the stages of my CFEngine evolution. Perhaps
you'll recognize yourself.</p>

            </section>
            <section id="section-2">
                <h3>Stage one, self contained bundles</h3>

<p>My first approach to policy writing were logical bundles, each having a
single high level purpose. This simple approach helped me to learn
CFEngine's declarative and convergent nature.</p>

<pre><code>bundle agent ntp
{
   packages:
      "ntpd"
         package_policy =&gt; "add",
         package_method =&gt; generic;

   files:
      "/etc/ntp.conf"
         copy_from =&gt; remote_dcp(
            "${sys.workdir}/sitefiles/ntp.conf", "${sys.policy_hub}" ),
         classes   =&gt; if_repaired( "restart_ntp" );

      "/etc/ntp.conf"
         perms =&gt; mog( "644", "root", "root" );

   processes:
      "ntpd"
         process_select =&gt; by_name( "^(/usr/sbin/)*ntpd" ),
         restart_classs =&gt; "restart_ntp";

   commands:
      restart_ntp::
         "/sbin/service ntpd restart"
            comtain =&gt; silent;
}

bundle agent ssh
{
   packages:
      "sshd"
         package_policy =&gt; "add",
         package_method =&gt; generic;

   files:
      "/etc/sshd_conf"
         copy_from =&gt; remote_dcp(
            "${sys.workdir}/sitefiles/sshd_conf", "${sys.policy_hub}" ),
         classes   =&gt; if_repaired( "restart_ssh" );

      "/etc/sshd_conf"
         perms =&gt; mog( "644", "root", "root" );

   processes:
      "sshd"
         process_select =&gt; by_name( "^(/usr/sbin/)*sshd" ),
         restart_classs =&gt; "restart_ssh";

   commands:
      restart_ssh::
         "/sbin/service sshd restart"
            comtain =&gt; silent;
}

bundle agent security
{
   files:
      "/etc/passwd"
         perms =&gt; mog( "644", "root", "root" );

      "/etc/shadow"
         perms =&gt; mog( "600", "root", "root" );

      "/tmp/."
         perms =&gt; mog( "777", "root", "root" );

}
</code></pre>

<p>As I wrote more of these bundles I noticed how alike they were and how
much duplication I was suffering. There were package promises in each
service bundle plus another package bundle for packages not related to
services. If I changed something in one bundle, I often had to make the
same change in many bundles. I knew I had to move on to something more
efficient.</p>

<h3>Stage two, reusable method calls.</h3>

<p>CFEngine's early documentation hinted at methods and reusable policy.
In those days the documentation was sparse and good examples were rare,
but after stage one I had many examples and I saw how methods could be
employed.</p>

<pre><code>bundle agent security
( path, mode, owner, group )
{
   files:
      "${path}"
         perms =&gt; mog( "${mode}", "${owner}", "${group}" );
}

bundle agent service
( package, config_file, process, command, mode, owner, group )
{
   packages:
      "${package}"
         package_policy =&gt; "add",
         package_method =&gt; generic;

   files:
      "${config_file}"
         copy_from =&gt; remote_dcp( "${sys.workdir}/sitefiles/${config_file}", "${sys.policy_hub}" ),
         classes   =&gt; if_repaired( "restart_${process}" );

      "${config_file}"
         perms =&gt; mog( "${mode}", "${owner}" "${group}" );

   processes:
      "${process}"
         process_select =&gt; by_name( "${process}" ),
         restart_classs =&gt; "restart_${process}";

   commands:
      "${command}"
         ifvarclass =&gt; canonify( "restart_${process}" ),
         comtain    =&gt; silent;
}

bundle agent main
{
   vars:
      "service[ntp][package]"     string =&gt; "ntpd";
      "service[ntp][config_file]" string =&gt; "/etc/ntp.conf";
      "service[ntp][process]"     string =&gt; "^/usr/sbin/ntpd";
      "service[ntp][command]"     string =&gt; "/sbin/service ntp restart";
      "service[ntp][mode]"        string =&gt; "644";
      "service[ntp][owner]"       string =&gt; "root";
      "service[ntp][group]"       string =&gt; "root";

      "service[ssh][package]"     string =&gt; "openssh-server";
      "service[ssh][config_file]" string =&gt; "/etc/ssh/sshd_conf";
      "service[ssh][process]"     string =&gt; "^/usr/sbin/sshd";
      "service[ssh][command]"     string =&gt; "/sbin/service sshd restart";
      "service[ssh][mode]"        string =&gt; "644";
      "service[ssh][owner]"       string =&gt; "root";
      "service[ssh][group]"       string =&gt; "root";

      "svc" slist =&gt; getindices( "service" );

      "security[passwd][path]"  string =&gt; "/etc/passwd";
      "security[passwd][mode]"  string =&gt; "644";
      "secuirty[passwd][owner]" string =&gt; "root";
      "security[passwd][group]" string =&gt; "root";

      "security[shadow][path]"  string =&gt; "/etc/shadow";
      "security[shadow][mode]"  string =&gt; "600";
      "secuirty[shadow][owner]" string =&gt; "root";
      "security[shadow][group]" string =&gt; "root";

      "security[tmp][path]"  string =&gt; "/tmp/.";
      "security[tmp][mode]"  string =&gt; "777";
      "secuirty[tmp][owner]" string =&gt; "root";
      "security[tmp][group]" string =&gt; "root";

      "sec" slist =&gt; getindices( "security" );

   methods:
      "${service[${svc}][package]}"
         usebundle =&gt; service(
            "${service[${svc}][package]}",
            "${service[${svc}][confi_file]}",
            "${service[${svc}][process]}",
            "${service[${svc}][command]}"
            "${service[${svc}][mode]}"
            "${service[${svc}][owner]}"
            "${service[${svc}][group]}"
            );

      "${security[${sec}][path]}"
         usebundle =&gt; security(
            "${security[${sec}][path]}",
            "${security[${sec}][mode]}"
            "${security[${sec}][owner]}"
            "${security[${sec}][group]}"
            );
}
</code></pre>

<p>There were further steps I could take to reduce the above code, but the
tedious variable syntax remained. I was so lazy, and still am, that
even the long list of methods promises drove me to find a better way.</p>

<h3>Stage three, reusable data driven policy.</h3>

<p>CFEngine promise types are low level: files, processes, command,
packages, etc. My need for order drove me to group promises as I've
shown, but must I be so literal? Why can't I write policy at a similar
low level, but with conceptual rather than literal logical groupings?
This is when EFL was born. Low level reusable bundles driven by simple
data files. EFL has bundles similar to stage two, but more low level
and more flexible. There are bundles for package promises, services,
file permissions, and much more.</p>

<p>Here is the more condensed data for file permissions with less syntax.</p>

<h4>efl_files_perms.json</h4>

<pre><code>[
  {
     "leaf_regex" : ".*",
     "group" : "security",
     "negate" : "644",
     "owner" : "root",
     "file_promiser" : "/etc/passwd",
     "class" : "any",
     "mode" : "root",
     "recurse_level" : "no"
  },
  {
     "leaf_regex" : ".*",
     "owner" : "root",
     "group" : "security",
     "negate" : "600",
     "class" : "any",
     "file_promiser" : "/etc/shadow",
     "recurse_level" : "no",
     "mode" : "root"
  },
  {
     "leaf_regex" : ".*",
     "owner" : "root",
     "group" : "security",
     "negate" : "777",
     "class" : "any",
     "file_promiser" : "/tmp",
     "recurse_level" : "no",
     "mode" : "root"
  }
]
</code></pre>

<p>Here is the more condensed data for services with less syntax.</p>

<h4>efl_services.json</h4>

<pre><code>[
  {
     "template" : "no",
     "restart_cmd" : "/sbin/service ntp restart",
     "class" : "any",
     "config_file" : "/etc/ntp.conf",
     "server" : "efl_c.policy_servers",
     "config_file_src" : "${sys.workdir}/sitefiles/etc/ntp.conf",
     "promisee" : "ntp time sync",
     "mode" : "644",
     "owner" : "root",
     "encrypt" : "no",
     "group" : "root",
     "process_regex" : "^/usr/sbin/ntpd"
  },
  {
     "encrypt" : "no",
     "group" : "root",
     "mode" : "644",
     "owner" : "root",
     "process_regex" : "^/usr/sbin/sshd",
     "class" : "any",
     "config_file" : "/etc/ssh/sshd_conf",
     "template" : "no",
     "restart_cmd" : "/sbin/service sshd restart",
     "promisee" : "sshd remote access, security",
     "server" : "efl_c.policy_servers",
     "config_file_src" : "${sys.workdir}/sitefiles/etc/ssh/sshd_conf"
  }
]
</code></pre>

<p>Here is the more condensed data for method promises to call the EFL
bundles.</p>

<h4>efl_main.json</h4>

<pre><code>[
  {
     "promiser" : "File permissions",
     "promisee" : "file permissions",
     "class" : "any",
     "parameter" : "${sys.workdir}/inputs/params/efl_file_perms.txt",
     "bundle" : "efl_file_perms",
     "ifelapsed" : "1"
  },
  {
     "ifelapsed" : "1",
     "parameter" : "${sys.workdir}/inputs/params/efl_services.txt",
     "bundle" : "efl_services",
     "class" : "any",
     "promisee" : "services",
     "promiser" : "services"
  }
]
</code></pre>

<p>Now I don't have to add new policy to make new promises. I simply edit
the data files. But are these promisers still logically grouped? Yes
they are. Each data files has a promisee in the last column. The same
promisee, or key words in the promisee, in multiple records or files
represents the logical relationship between the promisers. Finding a
logical group is only a grep away. Does this sound familiar?</p>

<h3>Further reading</h3>

<ul>
<li><p><a href="/simple-cfengine-server-access-promises-using-efl/">How to use EFL.</a></p></li>
<li><p><a href="/secure-sysctl-settings-with-cfengine/">Promising sysctlt with EFL.</a></p></li>
<li><p><a href="/simple-cfengine-server-access-promises-using-efl/">Promising cf-serverd access promises with EFL.</a></p></li>
<li><p><a href="/bulding-cfengine-classes-using-efl/">Building soft classes with EFL.</a></p></li>
</ul>

            </section>
        </main>


    </div>

    <div class="col-md-3">
        <iframe src="https://duckduckgo.com/search.html?site=watson-wilson.ca&prefill=Search DuckDuckGo" style="overflow:hidden;margin:0;padding:0;width:350px;height:40px;" frameborder="0"></iframe>

        <nav id="tags">
            <h1>Tags</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/ansible/">ansible</a></li>
                <li><a href="/blog/tag/anti-virus/">anti-virus</a></li>
                <li><a href="/blog/tag/apt/">apt</a></li>
                <li><a href="/blog/tag/asg/">asg</a></li>
                <li><a href="/blog/tag/autoscaling/">autoscaling</a></li>
                <li><a href="/blog/tag/aws/">AWS</a></li>
                <li><a href="/blog/tag/azure/">azure</a></li>
                <li><a href="/blog/tag/backup/">backup</a></li>
                <li><a href="/blog/tag/best-practices/">best practices</a></li>
                <li><a href="/blog/tag/bitbucket/">bitbucket</a></li>
                <li><a href="/blog/tag/bosh/">bosh</a></li>
                <li><a href="/blog/tag/cfengine/">cfengine</a></li>
                <li><a href="/blog/tag/cfengine-cookbook/">cfengine cookbook</a></li>
                <li><a href="/blog/tag/cheatsheet/">cheatsheet</a></li>
                <li><a href="/blog/tag/cli/">cli</a></li>
                <li><a href="/blog/tag/cloud/">cloud</a></li>
                <li><a href="/blog/tag/cloud-foundry/">cloud foundry</a></li>
                <li><a href="/blog/tag/cluster/">cluster</a></li>
                <li><a href="/blog/tag/conferences/">conferences</a></li>
                <li><a href="/blog/tag/configuration-management/">configuration management</a></li>
                <li><a href="/blog/tag/containers/">containers</a></li>
                <li><a href="/blog/tag/continuous-integration/">continuous integration</a></li>
                <li><a href="/blog/tag/cron/">cron</a></li>
                <li><a href="/blog/tag/debian/">debian</a></li>
                <li><a href="/blog/tag/delta-reporting/">delta reporting</a></li>
                <li><a href="/blog/tag/devops/">devops</a></li>
                <li><a href="/blog/tag/dns/">dns</a></li>
                <li><a href="/blog/tag/docker/">docker</a></li>
                <li><a href="/blog/tag/dr/">dr</a></li>
                <li><a href="/blog/tag/efl/">EFL</a></li>
                <li><a href="/blog/tag/ergonomics/">ergonomics</a></li>
                <li><a href="/blog/tag/github/">github</a></li>
                <li><a href="/blog/tag/heartbeat/">heartbeat</a></li>
                <li><a href="/blog/tag/high-availability/">high availability</a></li>
                <li><a href="/blog/tag/infosec/">infosec</a></li>
                <li><a href="/blog/tag/ipv6/">ipv6</a></li>
                <li><a href="/blog/tag/irc/">irc</a></li>
                <li><a href="/blog/tag/iscsi/">iscsi</a></li>
                <li><a href="/blog/tag/jekyll/">jekyll</a></li>
                <li><a href="/blog/tag/jq/">jq</a></li>
                <li><a href="/blog/tag/json/">json</a></li>
                <li><a href="/blog/tag/keyboard/">keyboard</a></li>
                <li><a href="/blog/tag/kickstart/">kickstart</a></li>
                <li><a href="/blog/tag/kvm/">kvm</a></li>
                <li><a href="/blog/tag/lambda/">lambda</a></li>
                <li><a href="/blog/tag/linux/">linux</a></li>
                <li><a href="/blog/tag/markdown/">markdown</a></li>
                <li><a href="/blog/tag/monitoring/">monitoring</a></li>
                <li><a href="/blog/tag/multipathd/">multipathd</a></li>
                <li><a href="/blog/tag/mustache/">mustache</a></li>
                <li><a href="/blog/tag/networking/">networking</a></li>
                <li><a href="/blog/tag/opennms/">opennms</a></li>
                <li><a href="/blog/tag/opensource/">opensource</a></li>
                <li><a href="/blog/tag/oracle/">oracle</a></li>
                <li><a href="/blog/tag/orchestration/">orchestration</a></li>
                <li><a href="/blog/tag/patching/">patching</a></li>
                <li><a href="/blog/tag/pcre/">pcre</a></li>
                <li><a href="/blog/tag/perl/">perl</a></li>
                <li><a href="/blog/tag/posix/">posix</a></li>
                <li><a href="/blog/tag/programming/">programming</a></li>
                <li><a href="/blog/tag/provisioning/">provisioning</a></li>
                <li><a href="/blog/tag/python/">python</a></li>
                <li><a href="/blog/tag/red-hat/">red hat</a></li>
                <li><a href="/blog/tag/redhat/">redhat</a></li>
                <li><a href="/blog/tag/regex/">regex</a></li>
                <li><a href="/blog/tag/rhev/">rhev</a></li>
                <li><a href="/blog/tag/ruby/">ruby</a></li>
                <li><a href="/blog/tag/san/">san</a></li>
                <li><a href="/blog/tag/satellite/">satellite</a></li>
                <li><a href="/blog/tag/scripting/">scripting</a></li>
                <li><a href="/blog/tag/security/">security</a></li>
                <li><a href="/blog/tag/serverless/">serverless</a></li>
                <li><a href="/blog/tag/serverspec/">serverspec</a></li>
                <li><a href="/blog/tag/shell/">shell</a></li>
                <li><a href="/blog/tag/slaac/">slaac</a></li>
                <li><a href="/blog/tag/software-testing/">software testing</a></li>
                <li><a href="/blog/tag/solaris/">solaris</a></li>
                <li><a href="/blog/tag/spacewalk/">spacewalk</a></li>
                <li><a href="/blog/tag/ssh/">ssh</a></li>
                <li><a href="/blog/tag/statocles/">statocles</a></li>
                <li><a href="/blog/tag/subnet/">subnet</a></li>
                <li><a href="/blog/tag/subversion/">subversion</a></li>
                <li><a href="/blog/tag/sun/">sun</a></li>
                <li><a href="/blog/tag/support/">support</a></li>
                <li><a href="/blog/tag/svn/">svn</a></li>
                <li><a href="/blog/tag/sysadmin/">sysadmin</a></li>
                <li><a href="/blog/tag/sysctl/">sysctl</a></li>
                <li><a href="/blog/tag/terraform/">terraform</a></li>
                <li><a href="/blog/tag/virus/">virus</a></li>
                <li><a href="/blog/tag/vitualization/">vitualization</a></li>
                <li><a href="/blog/tag/website/">website</a></li>
                <li><a href="/blog/tag/yaml/">yaml</a></li>
                <li><a href="/blog/tag/yamllint/">yamllint</a></li>
            </ul>
        </nav>
    </div>

</div>

<div class='row'>
   <div class='col-md-1'>
       <img atl='Neil Watson' src='https://gravatar.com/avatar/1f0969599955a953e592034929ed7a23' >
   </div>

       <div class='col-md-1'>
            <!-- reddit this -->
            <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false"><img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /></a>
       </div>

       <div class='col-md-1'>
          <!-- Tweet this -->
          <a class="twitter-share-button"
             href="https://twitter.com/intent/tweet">
          Tweet</a>
       </div>

       <div class='col-md-1'>
          <!-- follow me on twitter -->
         <a class="twitter-follow-button"
            data-show-count="false"
            data-show-screen-name="false"
           href="https://twitter.com/neil_h_watson">
         Follow @neil_h_watson</a>
        </div>

       <div class='col-md-1'>
           <!-- follw me on github -->
            <a aria-label="Follow @neilhwatson on GitHub" data-style="mega" href="https://github.com/neilhwatson" class="github-button">Follow</a>
            <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
       </div>

</div>

        </div>
        <footer>
            
            <h1></h1>
            <div class='col-md-5'> </div>
            <div class="col-md-3 container tagline">
                <a href="http://preaction.me/statocles">Made with Statocles</a><br/>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
